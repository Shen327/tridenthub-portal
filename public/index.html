<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TRIDENT HUB â€” Portal (REST + CRUD)</title>
  <style>
    :root{
      --bg:#0b1220;--bg2:#0e1626;--panel:#0f172a;--muted:#8aa0b8;--ring:#60a5fa;
      --fg:#e2e8f0;--fg2:#cbd5e1;--brand:#2563eb;--ok:#16a34a;--danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--fg);
         font:14px/1.45 system-ui,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif}
    .app{display:flex;height:100%}
    /* Sidebar */
    .sidebar{width:260px;min-width:240px;background:rgba(16,24,40,.90);backdrop-filter: blur(8px);
             border-right:1px solid rgba(255,255,255,.06);display:flex;flex-direction:column}
    .sidebar header{padding:16px 14px;border-bottom:1px solid rgba(255,255,255,.06);font-weight:700}
    .nav{padding:8px 6px;overflow:auto}
    .group{margin:10px 0}
    .group .title{opacity:.7;text-transform:uppercase;font-size:11px;letter-spacing:.12em;margin:6px 10px}
    .item{display:flex;gap:10px;align-items:center;padding:9px 10px;margin:4px 6px;border-radius:10px;cursor:pointer}
    .item:hover{background:rgba(255,255,255,.06)}
    .item.active{background:rgba(37,99,235,.18);outline:1px solid rgba(37,99,235,.35)}
    /* Main */
    .main{flex:1;display:flex;flex-direction:column;min-width:0}
    .toolbar{display:flex;justify-content:space-between;align-items:center;padding:14px;border-bottom:1px solid rgba(255,255,255,.06)}
    .search{display:flex;gap:8px;align-items:center;background:rgba(255,255,255,.06);padding:8px 12px;border-radius:10px;min-width:280px}
    .search input{all:unset;flex:1}
    .content{padding:16px;overflow:auto}
    .panel{background:var(--panel);border:1px solid #334155;border-radius:14px}
    .panel header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.06)}
    .panel .body{padding:12px 14px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:9px 12px;border:1px solid rgba(59,130,246,.55);border-radius:12px;background:linear-gradient(#2b65f6,#1d4ed8);color:#fff;font-weight:700}
    .btn.secondary{background:rgba(255,255,255,.06);border-color:#475569;color:#e5e7eb}
    .btn.danger{background:#b91c1c;border-color:#b91c1c}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid rgba(255,255,255,.06);padding:10px;text-align:left;vertical-align:top}
    th{font-size:12px;color:var(--fg2)}
    tr:hover td{background:rgba(255,255,255,.03)}
    .muted{color:var(--muted)}
    dialog{background:rgba(16,24,40,.98);border:1px solid rgba(255,255,255,.1);border-radius:16px}
    dialog form{padding:16px}
    label{display:block;margin-bottom:6px;font-size:12px;color:var(--fg2);font-weight:600}
    input,select,textarea{width:100%;background:#0b1220;border:1px solid #3a4a61;color:var(--fg);padding:8px;border-radius:10px}
    input:focus,select:focus,textarea:focus{outline:2px solid var(--ring);box-shadow:0 0 0 3px rgba(96,165,250,.25);border-color:#60a5fa}
    .toast{position:fixed;right:16px;bottom:14px;background:#0b1220;border:1px solid #475569;border-radius:12px;padding:10px 12px;box-shadow:0 10px 20px rgba(0,0,0,.35);z-index:60}
    /* Lock card */
    #lock{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#0b1220;border:1px solid #475569;border-radius:16px;padding:18px;width:min(520px,92vw);z-index:50}
    #lock h3{margin:0 0 10px}
    #lock .row{display:flex;gap:8px}
    #error{display:none;background:rgba(239,68,68,.15);color:#fecaca;border:1px solid rgba(239,68,68,.35);padding:8px 10px;border-radius:10px;margin:8px 0}
    @media (max-width: 880px){ .sidebar{position:fixed;transform:translateX(-100%);z-index:70;transition:.25s} .sidebar.show{transform:translateX(0)} }
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar" id="sidebar"></aside>

  <main class="main">
    <div class="toolbar">
      <div class="search">
        <span class="muted">ðŸ”Ž</span>
        <input id="q" placeholder="Search records (âŒ˜/Ctrl + K)" />
      </div>
      <div class="actions">
        <button class="btn secondary" id="exportCsv">Export CSV</button>
        <button class="btn" id="newBtn">+ New</button>
      </div>
    </div>

    <div class="content">
      <div class="panel">
        <header>
          <div>
            <h3 id="title" style="margin:0">Services</h3>
            <div class="muted"><span id="count">0</span> row(s)</div>
          </div>
          <div class="muted" id="statusText"></div>
        </header>
        <div class="body" id="viewHost"></div>
      </div>
    </div>
  </main>
</div>

<!-- Toast -->

<div id="toast" class="toast" style="display:none"></div>

<!-- Lock / passgate -->
<div id="lock">
  <h3>Enter Passcode</h3>
  <div id="error">Incorrect passcode. Try again.</div>
  <div class="row">
    <input id="lockpw" type="password" placeholder="Passcode" autocomplete="off" required />
    <button class="btn" id="unlock">Unlock</button>
  </div>
</div>

<script>
/* ===================== BASIC UTILS ===================== */
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
function toast(msg){ const t=$("#toast"); t.textContent=msg; t.style.display='block'; setTimeout(()=>{t.style.display='none';}, 2600); }
function showErrBar(msg){ toast(msg); }
function fmt(v){ return v==null ? '' : String(v); }

/* ===================== SUPABASE (REST) ===================== */
const SUPABASE_URL = "https://hsjinkyuxfgeqxervcmz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhzamlua3l1eGZnZXF4ZXJ2Y216Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzMzkzNjAsImV4cCI6MjA2ODkxNTM2MH0.0frju_BvUsDw4OaGFQHbqlgel4n-2aWBB-569bm-CQU";

/* Direct REST helpers */
const REST = `${SUPABASE_URL}/rest/v1`;
  
function baseHeaders() {
  return {
    apikey: SUPABASE_ANON_KEY,
    Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
    'Content-Type': 'application/json'
  };
}

function toQS(obj) {
  const u = new URLSearchParams();
  for (const [k, v] of Object.entries(obj || {})) {
    if (v === undefined || v === null || v === '') continue;
    u.set(k, v);
  }
  return u.toString();
}

function buildFilters(filters = {}) {
  const out = {};
  for (const [col, rule] of Object.entries(filters)) {
    if (rule && typeof rule === 'object' && 'op' in rule) out[col] = `${rule.op}.${rule.value}`;
    else out[col] = `eq.${rule}`;
  }
  return out;
}
function buildOrIlike(columns = [], term = '') {
  if (!term || !columns.length) return {};
  const pats = columns.map(c => `${c}.ilike.*${term.replaceAll('%','\\%')}*`);
  return { or: `(${pats.join(',')})` };
}

async function restFetch(path, { method = 'GET', body, prefer } = {}) {
  const headers = { ...baseHeaders(), 'Content-Type': 'application/json' };
  if (prefer) headers['Prefer'] = prefer;

  // Build absolute URL to Supabase REST
  const url = path.startsWith('http')
    ? path
    : `${REST}/${path.replace(/^\/+/, '')}`;

  // ðŸ”Ž quick debug so you can see the exact URL/method in DevTools
  console.log('[REST]', method, url);

  const res = await fetch(url, {
    method,
    headers,
    body: body ? JSON.stringify(body) : undefined,
    mode: 'cors'
  });

  // If it fails, try to print the error body (if any)
  if (!res.ok) {
    let text = '';
    try { text = await res.text(); } catch {}
    throw new Error(text || `${res.status} ${res.statusText}`);
  }
  return res.status === 204 ? null : res.json();
}

function restOrder(order) {
  if (!order) return null;
  const desc = order.startsWith('-');
  const col = desc ? order.slice(1) : order;
  return `${col}.${desc ? 'desc' : 'asc'}`;
}

// ---------- CRUD helpers your tables already use ----------
async function restSelect(
  table,
  { select='*', filters={}, search=null, order=null, limit=null, offset=null } = {}
){
  const qs = {
    select,
    ...buildFilters(filters),
    ...(search ? buildOrIlike(search.columns, search.term) : {})
  };
  const ord = restOrder(order);
  if (ord) qs.order = ord;
  if (limit != null)  qs.limit  = String(limit);
  if (offset != null) qs.offset = String(offset);

  const url = `${table}?${toQS(qs)}`;
  return restFetch(url, { method: 'GET' });
}

async function restInsert(table, row) {
  return restFetch(table, {
    method: 'POST',
    body: row,
    prefer: 'return=representation'
  });
}
async function restUpdate(table, id, patch) {
  return restFetch(`${table}?id=eq.${id}`, {
    method: 'PATCH',
    body: patch,
    prefer: 'return=representation'
  });
}
async function restDelete(table, id) {
  return restFetch(`${table}?id=eq.${id}`, {
    method: 'DELETE',
    prefer: 'return=representation'
  });
}

/* ===================== PASSGATE ===================== */
const PASS_PLAIN = "TRIDENTHUB_portal";
const PASS_SALT  = "ideal-lab-trident-2025";
const PASS_ITER  = 150000;
// PBKDF2-SHA256(TRIDENTHUB_portal, salt, 150000) = 089d2a57b838e21e6d15e2047a8fa824d4a0132744ce7141db0aea3fd940218f
const PASS_HASH  = "089d2a57b838e21e6d15e2047a8fa824d4a0132744ce7141db0aea3fd940218f";
const ALLOW_DEV_FALLBACK = true; // allows plain-text match on file:// or if subtle crypto unavailable

let SESSION_RUNTIME_UNLOCKED=false;
function isUnlocked(){ return SESSION_RUNTIME_UNLOCKED; }
function setUnlocked(){ SESSION_RUNTIME_UNLOCKED=true; $("#lock").hidden=true; $("#who").textContent="Unlocked"; }
function lock(){ SESSION_RUNTIME_UNLOCKED=false; $("#who").textContent="Locked"; $("#lock").hidden=false; }

async function hashPass(p,s=PASS_SALT,i=PASS_ITER){
  if(!window.crypto?.subtle) return null;
  const enc=new TextEncoder();
  const key=await crypto.subtle.importKey("raw",enc.encode(p),"PBKDF2",false,["deriveBits"]);
  const bits=await crypto.subtle.deriveBits({name:"PBKDF2",hash:"SHA-256",salt:enc.encode(s),iterations:i},key,256);
  return Array.from(new Uint8Array(bits)).map(b=>b.toString(16).padStart(2,'0')).join("");
}

$("#unlock").addEventListener("click", async ()=>{
  const pw = $("#lockpw").value || "";
  $("#error").style.display="none";
  try{
    const digest = await hashPass(pw);
    if( (digest && digest===PASS_HASH) || (!digest && ALLOW_DEV_FALLBACK && pw===PASS_PLAIN) ){
      setUnlocked();
      renderSidebar();   // update state
      await syncAll();
      return;
    }
  }catch(e){ /* ignore */ }
  $("#error").style.display="block";
});

/* ===================== DATA + NAV + VIEWS ===================== */
let currentView = "services";
const db={ tasks:[], clients:[], sites:[], equipments:[], inspections:[] };

/* Sidebar model */
const NAV = [
  { title:"Sales", items:[ {key:"new_contracts",label:"New Contract"} ] },
  { title:"Project", items:[ {key:"new_installation",label:"New Installation"} ] },
  { title:"Service Ops", items:[
      {key:"services",label:"Services"},
      {key:"callbacks",label:"Call Back"},
      {key:"repairs",label:"Repair"},
      {key:"clients",label:"Clients"},
      {key:"sites",label:"Sites"},
      {key:"equipments",label:"Equipments"},
      {key:"maintenance",label:"Maintenance"}
  ]},
  { title:"Compliance", items:[ {key:"inspections",label:"Inspections"} ] }
];
const WIRED_VIEWS = new Set(["services","callbacks","repairs","clients","sites","equipments","inspections"]);

function renderSidebar(){
  const sb = $("#sidebar");
  sb.innerHTML = `
    <header>ðŸš€ TRIDENT HUB</header>
    <div class="nav">
      ${NAV.map(g => `
        <div class="group">
          <div class="title">${g.title}</div>
          ${g.items.map(it => `
            <div class="item ${currentView===it.key?'active':''}" data-view="${it.key}">${it.label}</div>
          `).join('')}
        </div>
      `).join('')}
    </div>
    <div class="footer" style="padding:12px 14px;border-top:1px solid rgba(255,255,255,.06)">
      Logged in as <b id="who">${isUnlocked()?'Unlocked':'Locked'}</b>
    </div>
  `;
  $$(".item", sb).forEach(el=> el.addEventListener("click", ()=> setActive(el.dataset.view)) );
}

function setActive(v){
  currentView=v;
  renderSidebar();   // refresh active highlight
  render();          // refresh main panel
}

async function syncAll(){
  try{
    const [tasks, clients, sites, equips, insp] = await Promise.all([
      restSelect("tasks"),
      restSelect("clients"),
      restSelect("sites"),
      restSelect("equipments"),
      restSelect("inspections")
    ]);
    db.tasks = tasks || [];
    db.clients = clients || [];
    db.sites = sites || [];
    db.equipments = equips || [];
    db.inspections = insp || [];
  }catch(e){ showErrBar("Fetch error: "+e.message); }
  render();
}

/* ---- Table view renderer ---- */
function render(){
  if(!isUnlocked()){ $("#viewHost").innerHTML = '<div class="muted">Locked.</div>'; return; }

  const host = $("#viewHost");
  let rows = [];
  let cols = [];
  let title = "";

  if(currentView==="services"||currentView==="callbacks"||currentView==="repairs"){
    const typ = currentView==="services"?"service":(currentView==="callbacks"?"callback":"repair");
    rows = (db.tasks||[]).filter(t=> (t.type||"").toLowerCase()===typ );
    cols = ["id","title","status","technician_name","assigned_to","due_date","due_time","duration_min","site_id"];
    title = currentView[0].toUpperCase()+currentView.slice(1);
  } else if(currentView==="clients"){ rows=db.clients; cols=["id","name","email","phone"]; title="Clients"; }
    else if(currentView==="sites"){ rows=db.sites; cols=["id","name","address","city"]; title="Sites"; }
    else if(currentView==="equipments"){ rows=db.equipments; cols=["id","type","location","pma","serial_number","brand"]; title="Equipments"; }
    else if(currentView==="inspections"){ rows=db.inspections; cols=["id","type","site_id","created_at","status"]; title="Inspections"; }

  // Fallback for non-wired views
  if(!WIRED_VIEWS.has(currentView)){
    const name = currentView.replace(/_/g,' ');
    $("#title").textContent = name[0].toUpperCase()+name.slice(1);
    $("#count").textContent = 0;
    host.innerHTML = `
      <div class="muted">This page is not connected to data yet.</div>
      <div style="margin-top:10px"><button class="btn" id="connectNow">+ Connect to data</button></div>
    `;
    return;
  }

  $("#title").textContent = title;
  $("#count").textContent = rows?.length||0;

  const thead = '<thead><tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'<th width="1%"></th></tr></thead>';
  const tbody = '<tbody>'+ (rows||[]).map(r=>{
      const id = r.id;
      const tds = cols.map(c=>`<td>${fmt(r[c])}</td>`).join('');
      return `<tr data-id="${id}">${tds}<td><button class="btn secondary" data-edit="${id}">Edit</button> <button class="btn danger" data-del="${id}">Del</button></td></tr>`;
  }).join('') +'</tbody>';

  host.innerHTML = `<table>${thead}${tbody}</table>`;

  // bind row actions
  host.querySelectorAll('[data-edit]').forEach(b=> b.addEventListener('click', ()=> openForm(currentView, b.dataset.edit)) );
  host.querySelectorAll('[data-del]').forEach(b=> b.addEventListener('click', ()=> removeRow(currentView, b.dataset.del)) );
}

/* ---- Schema per view (editable fields) ---- */
const schemas = {
  services: [
    {key:'title',label:'Title',required:true},
    {key:'status',label:'Status'},
    {key:'technician_name',label:'Technician'},
    {key:'assigned_to',label:'Assigned to'},
    {key:'due_date',label:'Due date'},
    {key:'due_time',label:'Due time'},
    {key:'duration_min',label:'Duration (min)',type:'number'},
    {key:'site_id',label:'Site ID',type:'number'},
    {key:'description',label:'Description',type:'textarea'}
  ],
  callbacks: [
    {key:'title',label:'Title',required:true},
    {key:'status',label:'Status'},
    {key:'technician_name',label:'Technician'},
    {key:'assigned_to',label:'Assigned to'},
    {key:'due_date',label:'Due date'},
    {key:'due_time',label:'Due time'},
    {key:'duration_min',label:'Duration (min)',type:'number'},
    {key:'site_id',label:'Site ID',type:'number'},
    {key:'description',label:'Description',type:'textarea'}
  ],
  repairs: [
    {key:'title',label:'Title',required:true},
    {key:'status',label:'Status'},
    {key:'technician_name',label:'Technician'},
    {key:'assigned_to',label:'Assigned to'},
    {key:'due_date',label:'Due date'},
    {key:'due_time',label:'Due time'},
    {key:'duration_min',label:'Duration (min)',type:'number'},
    {key:'site_id',label:'Site ID',type:'number'},
    {key:'description',label:'Description',type:'textarea'}
  ],
  clients: [
    {key:'name',label:'Name',required:true},
    {key:'email',label:'Email'},
    {key:'phone',label:'Phone'}
  ],
  sites: [
    {key:'name',label:'Name',required:true},
    {key:'address',label:'Address'},
    {key:'city',label:'City'}
  ],
  equipments: [
    {key:'type',label:'Type'},
    {key:'location',label:'Location'},
    {key:'pma',label:'PMA'},
    {key:'serial_number',label:'Serial #'},
    {key:'brand',label:'Brand'}
  ],
  inspections: [
    {key:'type',label:'Type'},
    {key:'site_id',label:'Site ID',type:'number'},
    {key:'status',label:'Status'}
  ]
};

function fieldsFor(view){
  if(view==="services"||view==="callbacks"||view==="repairs") return schemas[view];
  return schemas[view]||[];
}

function fieldHTML(f, val=""){
  const id = "f_"+f.key;
  if(f.type==="textarea") return `<div style="grid-column:1/-1"><label for="${id}">${f.label}</label><textarea id="${id}" placeholder="${f.placeholder||''}">${fmt(val)}</textarea></div>`;
  return `<div><label for="${id}">${f.label}${f.required?' *':''}</label><input id="${id}" ${f.type?`type="${f.type}"`:''} value="${fmt(val)}"/></div>`;
}

function collectFrom(dlg, view){
  const out = {};
  for(const f of fieldsFor(view)){
    const el = dlg.querySelector("#f_"+f.key);
    let v = (el?.value ?? "").trim();
    if(f.type==="number" && v!=="") v = Number(v);
    if(f.required && !v){ el?.focus(); el?.reportValidity?.(); return null; }
    out[f.key]= v===""?null:v;
  }
  return out;
}

function openForm(view, id){
  const isTask = (view==="services"||view==="callbacks"||view==="repairs");
  const fixedType = isTask ? (view==="services"?"service":(view==="callbacks"?"callback":"repair")) : null;
  const source = isTask ? db.tasks : db[view];
  const row = (id? source.find(r=> String(r.id)===String(id)) : null) || {};
  const dlg = document.createElement("dialog");
  dlg.innerHTML = `<form method="dialog">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0">${id?'Edit':'Add'} ${view.replace(/_/g,' ').replace(/\b\w/g,c=>c.toUpperCase())}</h3>
      <button class="btn secondary" value="close">âœ•</button>
    </header>
    <div class="grid" style="display:grid;grid-template-columns:repeat(2,minmax(160px,1fr));gap:12px">
      ${fieldsFor(view).map(f=> fieldHTML(f, row[f.key]) ).join('')}
    </div>
    <div style="display:flex;justify-content:space-between;gap:8px;margin-top:14px">
      <div>${ id ? `<button class="btn danger" id="delBtn">Delete</button>` : '' }</div>
      <div>
        <button class="btn secondary" value="close">Cancel</button>
        <button class="btn" id="saveBtn" value="default">${id?'Save':'Create'}</button>
      </div>
    </div>
  </form>`;
  document.body.appendChild(dlg); dlg.showModal();
  dlg.addEventListener("close", ()=> dlg.remove());

  $("#saveBtn", dlg)?.addEventListener("click", async (e)=>{
    e.preventDefault();
    const payload = collectFrom(dlg, view); if(!payload) return;
    try{
      if(isTask) payload.type = fixedType;
      if(id) await updateRow(view, id, payload);
      else await addRow(view, payload);
      await syncAll(); dlg.close();
    }catch(err){ showErrBar(err.message); }
  });

  $("#delBtn", dlg)?.addEventListener("click", async (e)=>{
    e.preventDefault();
    if(confirm("Delete this record?")){ try{ await removeRow(view, id); await syncAll(); dlg.close(); }catch(err){ showErrBar(err.message);} }
  });
}

async function addRow(view, payload){
  if(view==="services"||view==="callbacks"||view==="repairs"){ await restInsert("tasks", payload); }
  else { await restInsert(view, payload); }
}
async function updateRow(view, id, patch){
  if(view==="services"||view==="callbacks"||view==="repairs"){ await restUpdate("tasks", id, patch); }
  else { await restUpdate(view, id, patch); }
}
async function removeRow(view, id){
  if(view==="services"||view==="callbacks"||view==="repairs"){ await restDelete("tasks", id); }
  else { await restDelete(view, id); }
}

/* buttons */
$("#newBtn").addEventListener("click", ()=> openForm(currentView, null) );
$("#exportCsv").addEventListener("click", ()=>{
  try{ exportCurrentTableToCsv(); toast("CSV exported."); }catch(e){ showErrBar("Export failed: "+e.message); }
});

function exportCurrentTableToCsv(){
  const rows = Array.from($("#viewHost table tbody")?.rows||[]).map(tr=> Array.from(tr.cells).slice(0,-1).map(td=> `"${(td.textContent||'').replace(/"/g,'""')}"`).join(","));
  const header = Array.from($("#viewHost table thead tr")?.cells||[]).slice(0,-1).map(th=>th.textContent).join(",");
  const csv = [header, ...rows].join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`${currentView}.csv`; a.click(); URL.revokeObjectURL(a.href);
}

/* init */
renderSidebar();
document.addEventListener("keydown", e=>{
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); $("#q").focus(); }
});
</script>
</body>
</html>
