<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TRIDENT Portal</title>
  <style>
    :root{
      --bg:#0b1220;--bg2:#0e1626;--panel:#0f172a;--muted:#8aa0b8;--ring:#60a5fa;
      --fg:#e2e8f0;--fg2:#cbd5e1;--brand:#2563eb;--ok:#16a34a;--danger:#ef4444;
      /* Dialog (more viewable) */
      --dlg-bg:#101a2b; --dlg-fg:#eef5ff; --dlg-muted:#b8c9da;
      --dlg-key:#a8c8ff; --dlg-edge:#5f6f86; --dlg-row:#0f1a2a;
      --dlg-head:#16243a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--fg);
         font:14px/1.45 system-ui,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif}
    .app{display:flex;height:100%}
    /* Sidebar */
    .sidebar{width:260px;min-width:240px;background:rgba(16,24,40,.90);backdrop-filter: blur(8px);
             border-right:1px solid rgba(255,255,255,.06);display:flex;flex-direction:column}
    .sidebar header{padding:16px 14px;border-bottom:1px solid rgba(255,255,255,.06);font-weight:700}
    .nav{padding:8px 6px;overflow:auto}
    .group{margin:10px 0}
    .group .title{opacity:.7;text-transform:uppercase;font-size:11px;letter-spacing:.12em;margin:6px 10px}
    .item{display:flex;gap:10px;align-items:center;padding:9px 10px;margin:4px 6px;border-radius:10px;cursor:pointer}
    .item:hover{background:rgba(255,255,255,.06)}
    .item.active{background:rgba(37,99,235,.18);outline:1px solid rgba(37,99,235,.35)}
    /* Main */
    .main{flex:1;display:flex;flex-direction:column;min-width:0}
    .toolbar{display:flex;justify-content:space-between;align-items:center;padding:14px;border-bottom:1px solid rgba(255,255,255,.06)}
    .search{display:flex;gap:8px;align-items:center;background:rgba(255,255,255,.06);padding:8px 12px;border-radius:10px;min-width:280px}
    .search input{all:unset;flex:1}
    .content{padding:16px;overflow:auto}
    .panel{background:var(--panel);border:1px solid #334155;border-radius:14px}
    .panel header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.06)}
    .panel .body{padding:12px 14px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:9px 12px;border:1px solid rgba(59,130,246,.55);border-radius:12px;background:linear-gradient(#2b65f6,#1d4ed8);color:#fff;font-weight:700}
    .btn.secondary{background:rgba(255,255,255,.06);border-color:#475569;color:#e5e7eb}
    .btn.danger{background:#b91c1c;border-color:#b91c1c}
    .btn.neutral{background:rgba(255,255,255,.06);border-color:#64748b;color:#e2e8f0}
    .btn.sm { padding:.38rem .6rem; border-radius:10px; font-weight:600; }
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid rgba(255,255,255,.06);padding:10px;text-align:left;vertical-align:top}
    th{font-size:12px;color:var(--fg2)}
    tr:hover td{background:rgba(255,255,255,.03)}
    td.actions { width:1%; min-width:210px; white-space:nowrap; }
    td.actions .lr {display:flex; justify-content:flex-end; align-items:center; gap:.5rem; min-width:210px}
    .muted{color:var(--muted)}
    dialog{background:rgba(16,24,40,.98);border:1px solid rgba(255,255,255,.1);border-radius:16px}
    dialog form{padding:16px}
    label{display:block;margin-bottom:6px;font-size:12px;color:var(--fg2);font-weight:600}
    input,select,textarea{width:100%;background:#0b1220;border:1px solid #3a4a61;color:var(--fg);padding:8px;border-radius:10px}
    input:focus,select:focus,textarea:focus{outline:2px solid var(--ring);box-shadow:0 0 0 3px rgba(96,165,250,.25);border-color:#60a5fa}
    .toast{position:fixed;right:16px;bottom:14px;background:#0b1220;border:1px solid #475569;border-radius:12px;padding:10px 12px;box-shadow:0 10px 20px rgba(0,0,0,.35);z-index:60}
    /* Lock card */
    #lock{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#0b1220;border:1px solid #475569;border-radius:16px;padding:18px;width:min(520px,92vw);z-index:50}
    #lock h3{margin:0 0 10px}
    #lock .row{display:flex;gap:8px}
    #error{display:none;background:rgba(239,68,68,.15);color:#fecaca;border:1px solid rgba(239,68,68,.35);padding:8px 10px;border-radius:10px;margin:8px 0}
    @media (max-width: 880px){ .sidebar{position:fixed;transform:translateX(-100%);z-index:70;transition:.25s} .sidebar.show{transform:translateX(0)} }

    /* ===== Detail dialog (more viewable) ===== */
    dialog.details{
      color:var(--dlg-fg); background:var(--dlg-bg);
      border:1px solid var(--dlg-edge); border-radius:16px; padding:0;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
    }
    dialog.details::backdrop{ background:rgba(0,0,0,.72); }
    dialog.details form{ max-height:82vh; overflow:auto; padding:0; }
    dialog.details header{
      background:var(--dlg-head); padding:12px 16px;
      border-bottom:1px solid rgba(255,255,255,.08);
      position:sticky; top:0; z-index:1;
    }
    dialog.details .pad{ padding:16px; }
    dialog.details h3{ color:#fafdff; letter-spacing:.2px; margin:0; }
    dialog.details h4{ color:#f4f7fb; margin:14px 0 10px; }
    dialog.details table{
      width:100%; border-collapse:collapse; background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.10); border-radius:12px; overflow:hidden; font-size:13px;
    }
    dialog.details th{ color:#d7e2ee; background:rgba(255,255,255,.06); text-transform:uppercase; font-size:11px; letter-spacing:.06em; }
    dialog.details td, dialog.details th{ border-bottom:1px solid rgba(255,255,255,.09); padding:9px 11px; }
    dialog.details tbody tr:nth-child(even) td{ background:rgba(255,255,255,.02); }
    dialog.details tbody tr:hover td{ background:var(--dlg-row); }
    .badge{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:800; line-height:1.5; }
    /* --- Light theme for edit/add dialogs only (not the big .details viewer) --- */
    dialog:not(.details){
      background:#ffffff;
      color:#0b1220;
      border:1px solid #e2e8f0;
      border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.25);
      padding:0; /* keep form padding handling */
    }
    dialog:not(.details)::backdrop{
      background:rgba(0,0,0,.55);
    }

    /* Typography inside the light dialog */
    dialog:not(.details) h3{ color:#0b1220; }
    dialog:not(.details) label{ color:#334155; }

    /* Inputs in the light dialog */
    dialog:not(.details) input,
    dialog:not(.details) select,
    dialog:not(.details) textarea{
      background:#ffffff;
      color:#0b1220;
      border:1px solid #cbd5e1;
      border-radius:10px;
    }
    dialog:not(.details) input:focus,
    dialog:not(.details) select:focus,
    dialog:not(.details) textarea:focus{
      outline:2px solid #60a5fa;
      box-shadow:0 0 0 3px rgba(96,165,250,.25);
      border-color:#60a5fa;
    }

    /* Hint text inside the form */
    dialog:not(.details) .muted{ color:#64748b; }

    /* Buttons look fine on white; keep them as-is, but you can tweak if desired */
    /* .btn.secondary in light dialog */
    dialog:not(.details) .btn.secondary{
      background:#f1f5f9;
      border-color:#cbd5e1;
      color:#0f172a;
    }

  </style>

  <!-- Supabase JS for realtime & storage -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="app">
  <aside class="sidebar" id="sidebar"></aside>

  <main class="main">
    <div class="toolbar">
      <div class="search">
        <span class="muted">üîé</span>
        <input id="q" placeholder="Global Search" />
      </div>
      <div class="actions">
        <button class="btn secondary" id="exportCsv">Export CSV</button>
        <button class="btn secondary" id="importCsv">Import CSV</button>
        <input id="csvFile" type="file" accept=".csv,text/csv" style="display:none" />
        <button class="btn" id="newBtn">+ New</button>
      </div>
    </div>

    <div class="content">
      <div class="panel">
        <header>
          <div>
            <h3 id="title" style="margin:0">Services</h3>
            <div class="muted">
              <span id="count">0</span> row(s)
              <span id="countFiltered" style="display:none"> ‚Ä¢ <span id="countNow">0</span> shown</span>
            </div>
          </div>
          <div style="display:flex; gap:8px; align-items:center">
            <div class="search" style="min-width:240px">
              <span class="muted">üîç</span>
              <input id="pageQ" placeholder="Filter this page" />
            </div>
            <div class="muted" id="statusText"></div>
          </div>
        </header>
        <div class="body" id="viewHost"></div>
      </div>
    </div>
  </main>
</div>

<!-- Toast -->
<div id="toast" class="toast" style="display:none"></div>

<!-- Lock / passgate -->
<div id="lock">
  <h3>Enter Passcode</h3>
  <div id="error">Incorrect passcode. Try again.</div>
  <div class="row">
    <input id="lockpw" type="password" placeholder="Passcode" autocomplete="off" required />
    <button class="btn" id="unlock">Unlock</button>
  </div>
</div>

<script>
/* ===================== BASIC UTILS ===================== */
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const fmt = v => v==null ? '' : String(v);
const byId = (root, id) => root.querySelector('#' + CSS.escape(id));
function toast(msg){ const t=$("#toast"); t.textContent=msg; t.style.display='block'; setTimeout(()=>{t.style.display='none';}, 2800); }
function parseTS(x){ try{ return x? new Date(x): null }catch{ return null } }
function minutesDiff(a,b){ if(!a||!b) return null; return Math.round((b-a)/60000) }

/* ===== Per-page search helpers ===== */
let PAGE_Q = "";
const debounce = (fn, ms=200) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
function rowMatches(row, q, cols){
  if(!q) return true;
  const needle=q.toLowerCase();
  for(const c of cols){
    const v=row?.[c];
    if(v==null) continue;
    if(String(v).toLowerCase().includes(needle)) return true;
  }
  return false;
}
function wirePageSearch(){
  const inp = document.getElementById("pageQ");
  if(!inp) return;
  inp.addEventListener("input", debounce(()=>{ PAGE_Q = inp.value.trim(); render(); },120));
  document.addEventListener("keydown", (e)=>{
    if(e.key === "/" && !e.metaKey && !e.ctrlKey && !e.altKey){
      e.preventDefault(); inp.focus();
    } else if(e.key === "Escape" && document.activeElement === inp){
      e.preventDefault(); inp.value=""; PAGE_Q=""; render();
    }
  });
}

/* ===================== SUPABASE (REST) ===================== */
const SUPABASE_URL  = 'https://cxxcrtxwrhxymlybxljs.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4eGNydHh3cmh4eW1seWJ4bGpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NDU4NzgsImV4cCI6MjA3NzEyMTg3OH0.ehMiF9uPgpW_eST549RvvlK2KrpPm9NJ1qhtz3tErqc';
const DOCS_BUCKET = 'portal_docs';

const REST = `${SUPABASE_URL}/rest/v1`;
async function restFetch(path, { method='GET', body, prefer } = {}) {
  const res = await fetch(`${REST}${path}`, {
    method,
    headers: {
      apikey: SUPABASE_ANON,
      Authorization: `Bearer ${SUPABASE_ANON}`,
      'Content-Type': 'application/json',
      ...(prefer ? { Prefer: prefer } : {})
    },
    body: body ? JSON.stringify(body) : undefined
  });
  if(!res.ok){
    const text = await res.text().catch(()=> '');
    throw new Error(`[${res.status}] ${text || res.statusText}`);
  }
  const ct = res.headers.get('content-type') || '';
  return ct.includes('application/json') ? res.json() : null;
}
const restSelect = (table, qs) => restFetch(`/${table}${qs?.startsWith('?')?qs:(qs?`?${qs}`:'')}`);
const restInsert = (table, rows) => restFetch(`/${table}`, { method:'POST', body: rows, prefer:'return=representation' });
const restUpdate = (table, filterQS, patch) => restFetch(`/${table}${filterQS}`, { method:'PATCH', body: patch, prefer:'return=representation' });
const restDelete = (table, filterQS) => restFetch(`/${table}${filterQS}`, { method:'DELETE' });

/* ---------- Fetch ALL helper (pagination) ---------- */
const PAGE_SIZE = 1000;
async function restSelectAll(table, qs = "", pageSize = PAGE_SIZE) {
  // normalize query string and guarantee select=*
  let base = qs ? (qs.startsWith("?") ? qs : `?${qs}`) : "?select=*";
  if (!/(\?|&)select=/.test(base)) base += (base.includes("?") ? "&" : "?") + "select=*";

  let offset = 0;
  const out = [];
  while (true) {
    const suffix = `${base}${base.includes("?") ? "&" : "?"}limit=${pageSize}&offset=${offset}`;
    const page = await restSelect(table, suffix);
    if (!page || page.length === 0) break;
    out.push(...page);
    if (page.length < pageSize) break;
    offset += pageSize;
  }
  return out;
}

// Realtime + Storage client
const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* ===================== PASSGATE ===================== */
const PASS_PLAIN="TRIDENTHUB_portal", PASS_SALT="ideal-lab-trident-2025", PASS_ITER=150000;
const PASS_HASH="089d2a57b838e21e6d15e2047a8fa824d4a0132744ce7141db0aea3fd940218f";
let UNLOCKED=false;
async function hashPass(p,s=PASS_SALT,i=PASS_ITER){
  if(!crypto?.subtle) return null;
  const enc=new TextEncoder();
  const key=await crypto.subtle.importKey("raw",enc.encode(p),"PBKDF2",false,["deriveBits"]);
  const bits=await crypto.subtle.deriveBits({name:"PBKDF2",hash:"SHA-256",salt:enc.encode(s),iterations:i},key,256);
  return Array.from(new Uint8Array(bits)).map(b=>b.toString(16).padStart(2,'0')).join("");
}
$("#unlock").addEventListener("click", async ()=>{
  $("#error").style.display="none";
  const dig = await hashPass($("#lockpw").value || "");
  if( (dig && dig===PASS_HASH) || (!dig && $("#lockpw").value===PASS_PLAIN) ){
    UNLOCKED=true; $("#lock").hidden=true; renderSidebar(); updateNewBtnLabel();
    await syncAll();
    wireRealtime(); // live updates
  } else { $("#error").style.display="block"; }
});

/* ===================== NAV / COLUMNS / SCHEMAS ===================== */
let currentView = "equipments";

const COLUMNS = {
  contracts: [ "building_name","equipment_type","location_state","pma_no","pma_expiry","cf_validate","contract_type","contract_status","remark"],
  sites: [ "company_name","site_name","site_address","site_phone","site_email","state","updated_at"],
  services:   [ "title","status","priority","assigned_to","due_date","location","equipment_pma","checked_in_at","checked_out_at","updated_at"],
  callbacks:  [ "title","status","priority","assigned_to","due_date","location","equipment_pma","checked_in_at","checked_out_at","updated_at"],
  repairs:    [ "title","status","priority","assigned_to","due_date","location","equipment_pma","checked_in_at","checked_out_at","updated_at"],
  inspection_cf:   [ "title","status","priority","assigned_to","scheduled_at","completed_at","location","equipment_pma","certificate_no","pma_expiry","updated_at"],
  inspection_14th: [ "title","status","priority","assigned_to","scheduled_at","completed_at","location","equipment_pma","certificate_no","pma_expiry","updated_at"],
  attendance: [ "user_id","user_name","check_in_at","check_out_at","location_name"],
  checkins:   [ "user_id","latitude","longitude","photo_path","created_at"],
  reports:    [ "task_id","title","description","location","equipment_pma","remark","check_in_at","check_out_at","completed_at","created_by_id","assigned_to_id"],
  equipments: [ "type","pma_no","name","location","brand","model_name","pma_status","pma_expiry","contract_status","contract_expiry","updated_at"],
  hr:              ["name","position","phone","email","employment_status","updated_at"],
  tools_mgmt:      ["tool_name","category","serial_no","status","assigned_to","location","calibration_due","updated_at"],
  sub_contractors: ["company_name","contact_person","phone","email","specialty","status","updated_at"],
  support:         ["title","category","priority","status","assigned_to","opened_at","updated_at"],
};

const SCHEMAS = {
  contracts: [
    {key:'building_name',label:'Building name'},
    {key:'brand',label:'Brand'},
    {key:'equipment_type',label:'Equipment type'},
    {key:'number_lift',label:'Number of lifts'},
    {key:'factory_code',label:'Factory code'},
    {key:'location_state',label:'Location (state)'},
    {key:'pma_no',label:'PMA no'},
    {key:'pma_expiry',label:'PMA expiry (date)'},
    {key:'cf_validate',label:'CF validate (date)'},
    {key:'rates_per_month',label:'Rates / month'},
    {key:'contract_type',label:'Contract type'},
    {key:'takeover_date',label:'Takeover date'},
    {key:'contract_start',label:'Contract start'},
    {key:'contract_end',label:'Contract end'},
    {key:'agreement_validity',label:'Agreement validity'},
    {key:'service',label:'Service'},
    {key:'contract_status',label:'Contract status'},
    {key:'remark',label:'Remark',type:'textarea'}
  ],
  task: [
    {key:'title',label:'Title',required:true},
    {key:'type',label:'Type (service/callback/repair/inspection)'},
    {key:'status',label:'Status (open/in_progress/closed)'},
    {key:'priority',label:'Priority (low/normal/high/urgent)'},
    {key:'assigned_to',label:'Assigned to'},
    {key:'location',label:'Location'},
    {key:'equipment_pma',label:'Equipment PMA'},
    {key:'due_date',label:'Due date (YYYY-MM-DD)'},
    {key:'checked_in_at',label:'Checked in at (ISO)'},
    {key:'checked_out_at',label:'Checked out at (ISO)'},
    {key:'remark',label:'Remark'},
    {key:'description',label:'Description',type:'textarea'}
  ],
  attendance: [
    {key:'user_id',label:'User id'},
    {key:'user_name',label:'User name'},
    {key:'check_in_at',label:'Check in at (ISO)'},
    {key:'check_out_at',label:'Check out at (ISO)'},
    {key:'location_name',label:'Location name'}
  ],
  reports: [
    {key:'task_id',label:'Task id'},
    {key:'title',label:'Title'},
    {key:'description',label:'Description',type:'textarea'},
    {key:'location',label:'Location'},
    {key:'equipment_pma',label:'Equipment PMA'},
    {key:'remark',label:'Remark'},
    {key:'check_in_at',label:'Check in at (ISO)'},
    {key:'check_out_at',label:'Check out at (ISO)'}
  ],
  equipments: [
    {key:'type',label:'Type'},
    {key:'pma_no',label:'PMA'},
    {key:'name',label:'Name'},
    {key:'location',label:'Location'},
    {key:'brand',label:'Brand'},
    {key:'model_name',label:'Model name'},
    {key:'capacity_kg',label:'Capacity (kg)'},
    {key:'capacity_persons',label:'Capacity (persons)'},
    {key:'capacity_persons_per_hour',label:'Capacity (persons / hour)'},
    {key:'speed_m/m',label:'Speed (m/m)'},
    {key:'rise_m',label:'Rise (m)'},
    {key:'stops_openings',label:'Stops / Openings'},
    {key:'stepwidth_mm',label:'Step width (mm)'},
    {key:'inclination',label:'Inclination'},
    {key:'machine_type',label:'Machine type'},
    {key:'motor_data',label:'Motor data',type:'textarea'},
    {key:'controller',label:'Controller'},
    {key:'software_version',label:'Software version'},
    {key:'operation',label:'Operation'},
    {key:'roping',label:'Roping'},
    {key:'rope_diameter',label:'Rope diameter'},
    {key:'rope_construction',label:'Rope construction'},
    {key:'pma_status',label:'PMA status'},
    {key:'pma_expiry',label:'PMA expiry (date)'},
    {key:'contract_status',label:'Contract status'},
    {key:'contract_expiry',label:'Contract expiry (date)'}
  ],
  sites: [
    {key:'company_name',label:'Company Name'},
    {key:'site_name',label:'Site Name'},
    {key:'site_address',label:'Site Address',type:'textarea'},
    {key:'site_phone',label:'Site Phone'},
    {key:'site_email',label:'Site Email'},
    {key:'state',label:'State'}
  ],
  inspection: [
    {key:'title',label:'Title'},
    {key:'status',label:'Status (open/in_progress/closed)'},
    {key:'priority',label:'Priority (low/normal/high/urgent)'},
    {key:'assigned_to',label:'Assigned to'},
    {key:'location',label:'Location'},
    {key:'equipment_pma',label:'Equipment PMA'},
    {key:'scheduled_at',label:'Scheduled at (ISO)'},
    {key:'started_at',label:'Started at (ISO)'},
    {key:'completed_at',label:'Completed at (ISO)'},
    {key:'result',label:'Result (pass/fail/‚Ä¶)'},
    {key:'certificate_no',label:'Certificate No.'},
    {key:'pma_expiry',label:'PMA expiry (date)'},
    {key:'next_due',label:'Next due (date)'},
    {key:'remark',label:'Remark',type:'textarea'}
  ],
  hr: [
    {key:"name",label:"Name",required:true},
    {key:"position",label:"Position"},
    {key:"phone",label:"Phone"},
    {key:"email",label:"Email"},
    {key:"employment_status",label:"Employment Status"}
  ],
  tools_mgmt: [
    {key:"tool_name",label:"Tool Name",required:true},
    {key:"category",label:"Category"},
    {key:"serial_no",label:"Serial No."},
    {key:"status",label:"Status"},
    {key:"assigned_to",label:"Assigned To"},
    {key:"location",label:"Location"},
    {key:"calibration_due",label:"Calibration Due (date)"}
  ],
  sub_contractors: [
    {key:"company_name",label:"Company Name",required:true},
    {key:"contact_person",label:"Contact Person"},
    {key:"phone",label:"Phone"},
    {key:"email",label:"Email"},
    {key:"specialty",label:"Specialty"},
    {key:"status",label:"Status"}
  ],
  support: [
    {key:"title",label:"Title",required:true},
    {key:"category",label:"Category"},
    {key:"priority",label:"Priority (low/normal/high/urgent)"},
    {key:"status",label:"Status (open/in_progress/closed)"},
    {key:"assigned_to",label:"Assigned To"},
    {key:"opened_at",label:"Opened at (ISO)"},
    {key:"remark",label:"Remark",type:"textarea"}
  ],
};

const NAV = [
  { title:"Sales", items:[]},
  { title:"Project", items:[
    {key:"new_install",  label:"New Installation"},
    {key:"new_modern",   label:"New Modernization"},
    {key:"new_contract", label:"New Contract"}
  ]},
  { title:"Service Operation", items:[
    {key:"contracts", label:"Services Contracts"}
    {key:"services",   label:"Services"},
    {key:"callbacks",  label:"Call Back"},
    {key:"repairs",    label:"Repair"},
    {key:"clients",    label:"Clients"},
    {key:"sites",      label:"Sites"},
    {key:"equipments", label:"Equipments"}
  ]},
  { title:"Compliance", items:[
    {key:"inspection_cf",   label:"CF Renewal Inspection"},
    {key:"inspection_14th", label:"14th Schedule Inspection"}
  ]},
  { title:"Resource Management", items:[
    {key:"hr",              label:"Human Resource"},
    {key:"tools_mgmt",      label:"Tools Management"},
    {key:"sub_contractors", label:"Sub-Contractor Management"},
    {key:"support",         label:"Troubleshooting Support"}
  ]},
];

/* Runtime store */
const store = {
  tasks:[], attendance:[], checkins:[], reports:[], equipments:[], sites:[], inspections:[],
  hr:[], tools_mgmt:[], sub_contractors:[], support:[], contracts:[]
};

/* ---------- GLOBAL SEARCH (full-DB) ---------- */
const SEARCHMAP = {
  contracts: ["building_name","brand","equipment_type","number_lift","factory_code","location_state","pma_no","contract_type","contract_status","remark"],
  equipments: ["pma_no","name","location","brand","model_name","pma_status","contract_status"],
  tasks: ["title","type","status","priority","assigned_to","equipment_pma","location","remark","description"],
  inspections: ["title","subtype","status","assigned_to","location","equipment_pma","certificate_no","result","remark"],
  reports: ["title","remark","equipment_pma","location","created_by_id","assigned_to_id"],
  attendance: ["user_id","user_name","location_name"],
  checkins: ["user_id","latitude","longitude","photo_path"],
  sites: ["company_name","site_name","site_address","site_phone","site_email","state"],
  hr: ["name","position","phone","email","employment_status"],
  tools_mgmt: ["tool_name","category","serial_no","status","assigned_to","location"],
  sub_contractors: ["company_name","contact_person","phone","email","specialty","status"],
  support: ["title","category","priority","status","assigned_to","remark"],
};
function buildOrFilter(q, cols) {
  const safe = encodeURIComponent(q);
  const pat  = `*${safe}*`;
  const parts = cols.map(c => `${c}.ilike.${pat}`);
  const exactCols = ["id","pma_no","equipment_pma","user_id","assigned_to_id","created_by_id"];
  for (const c of exactCols) if (cols.includes(c)) parts.push(`${c}.eq.${safe}`);
  return `?or=(${parts.join(",")})&select=*`;
}
(function wireSearchBox(){
  const qInput = document.getElementById('q');
  if(!qInput) return;
  qInput.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      e.preventDefault();
      const term = (qInput.value||'').trim();
      if(term) globalSearch(term);
    }
  });
})();
function smallColsFor(table) {
  const base = {
    contracts: ["building_name","brand","equipment_type","pma_no","contract_type","contract_status","updated_at"],
    equipments: [ "pma_no","name","location","brand","model_name","pma_status","contract_status","updated_at"],
    tasks: [ "title","type","status","priority","assigned_to","equipment_pma","due_date","updated_at"],
    reports: [ "title","remark","equipment_pma","created_at"],
    attendance: [ "user_name","check_in_at","check_out_at","location_name"],
    inspections: ["title","subtype","status","assigned_to","equipment_pma","completed_at","updated_at"],
    checkins: [ "user_id","latitude","longitude","created_at"]
  };
  return base[table] || [];
}
function renderMini(headers, rows) {
  if (!rows?.length) return `<div class="muted">No matches.</div>`;
  return `
    <div style="overflow:auto;border:1px solid rgba(255,255,255,.08);border-radius:10px">
      <table style="width:100%;border-collapse:collapse">
        <thead>
          <tr>${headers.map(h=>`<th style="padding:8px 10px;font-size:12px;color:var(--fg2);border-bottom:1px solid rgba(255,255,255,.08)">${h}</th>`).join("")}</tr>
        </thead>
        <tbody>
          ${rows.map(r=>`<tr>${headers.map(h=>`<td style="padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.06)">${fmt(r[h])}</td>`).join("")}</tr>`).join("")}
        </tbody>
      </table>
    </div>
  `;
}
async function globalSearch(q){
  if(!q || !UNLOCKED){ if(!UNLOCKED) toast("Unlock first"); return; }
  const requests = Object.entries(SEARCHMAP).map(async ([table, cols]) => {
    try {
      return [table, await restSelectAll(table, buildOrFilter(q, cols)) || []];
    } catch (e) {
      console.warn("search error", table, e);
      return [table, []];
    }
  });

  const dlg = document.createElement("dialog");
  dlg.className = "details";
  dlg.innerHTML = `
    <form method="dialog">
      <header>
        <h3>Search results for ‚Äú${q.replace(/</g,"&lt;")}‚Äù</h3>
        <button class="btn secondary" value="close" type="submit">Close</button>
      </header>
      <div class="pad" id="searchBody"><div class="muted">Searching‚Ä¶</div></div>
    </form>`;
  document.body.appendChild(dlg); dlg.showModal();
  dlg.addEventListener("close", ()=> dlg.remove());

  const pairs = await Promise.all(requests);
  const sections = pairs.map(([table, rows])=>{
    const headers = smallColsFor(table);
    const nice = table.replace("_"," ");
    return `
      <section style="margin:12px 0 18px">
        <h4 style="margin:0 0 10px">${nice} <span class="muted">(${rows.length})</span></h4>
        ${renderMini(headers, rows)}
      </section>`;
  }).join("");

  $("#searchBody", dlg).innerHTML = sections || `<div class="muted">No matches found.</div>`;
}

/* ===================== SIDEBAR ===================== */
function renderSidebar(){
  const sb = $("#sidebar");
  sb.innerHTML = `
    <header>TRIDENT HUB</header>
    <div class="nav">
      ${NAV.map(g => `
        <div class="group">
          <div class="title">${g.title}</div>
          ${g.items.map(it => `
            <div class="item ${currentView===it.key?'active':''}" data-view="${it.key}">${it.label}</div>
          `).join('')}
        </div>
      `).join('')}
    </div>`;
  $$(".item", sb).forEach(el=> el.addEventListener("click", ()=> setActive(el.dataset.view)) );
}
function setActive(v){ currentView=v; renderSidebar(); updateNewBtnLabel(); render(); }
function updateNewBtnLabel(){
  const map = {
    services:'Service', callbacks:'Callback', repairs:'Repair',
    equipments:'Equipments', contracts:'Contract', sites:'Site',
    inspection_cf:'Inspection', inspection_14th:'Inspection',
    hr:'Staff', tools_mgmt:'Tool', sub_contractors:'Sub-contractor',
    support:'Support Ticket'
  };
  $("#newBtn").textContent = `+ New ${map[currentView]||''}`.trim();
}

/* ===================== FETCH (ALL TABLES, ALL ROWS) ===================== */
async function syncAll(){
  const safe = p => p.then(x=>x||[]).catch(e=>{console.warn(e); return []});

  const [
    contracts, tasks, attendance, checkins, reports,
    equipments, sites, inspections, hr, tools_mgmt,
    sub_contractors, support
  ] = await Promise.all([
    safe(restSelectAll("contracts")),
    safe(restSelectAll("tasks")),
    safe(restSelectAll("attendance")),
    safe(restSelectAll("checkins")),
    safe(restSelectAll("reports")),
    safe(restSelectAll("equipments")),
    safe(restSelectAll("sites")),
    safe(restSelectAll("inspections")),
    safe(restSelectAll("hr")),
    safe(restSelectAll("tools_mgmt")),
    safe(restSelectAll("sub_contractors")),
    safe(restSelectAll("support"))
  ]);

  store.contracts        = contracts;
  store.tasks            = tasks;
  store.attendance       = attendance;
  store.checkins         = checkins;
  store.reports          = reports;
  store.equipments       = equipments;
  store.sites            = sites;
  store.inspections      = inspections;
  store.hr               = hr;
  store.tools_mgmt       = tools_mgmt;
  store.sub_contractors  = sub_contractors;
  store.support          = support;

  render();
}

/* ===================== RENDER ===================== */
const norm = (s)=> (s||"").toLowerCase();

function rowsFor(view){
  if (view === "contracts") return store.contracts || [];
  if (["services","callbacks","repairs"].includes(view)){
    const typ = view==="services"?"service":view==="callbacks"?"callback":"repair";
    return (store.tasks||[]).filter(t => norm(t.type)===typ);
  }
  if (view==="inspection_cf")
    return (store.inspections||[]).filter(x => x.subtype === 'cf_renewal');
  if (view==="inspection_14th")
    return (store.inspections||[]).filter(x => x.subtype === 'schedule_14th');
  if (view==="attendance"){
    return (store.attendance||[]).map(a=>{
      const ci=parseTS(a.check_in_at), co=parseTS(a.check_out_at);
      return {...a, duration_min: minutesDiff(ci,co) };
    });
  }
  if (view === "sites") return store.sites || [];
  if (view==="checkins")  return store.checkins||[];
  if (view==="reports")   return store.reports||[];
  if (view==="equipments"){
    return (store.equipments||[]).map(e => ({ id: e.id ?? e.pma_no ?? e.type, ...e }));
  }
  return [];
}

function render(){
  if(!UNLOCKED){ $("#viewHost").innerHTML = '<div class="muted">Locked.</div>'; return; }

  const allRows = rowsFor(currentView);
  const cols    = COLUMNS[currentView] || [];
  const rows = PAGE_Q
    ? allRows.filter(r => rowMatches(r, PAGE_Q, Object.keys(r || {})))
    : allRows;

  const title = currentView.replace(/_/g,' ').replace(/^\w/,c=>c.toUpperCase());
  $("#title").textContent = title;

  $("#count").textContent = allRows?.length || 0;
  const cf = $("#countFiltered"), cn = $("#countNow");
  if (PAGE_Q && allRows) { cf.style.display = "inline"; cn.textContent = rows.length; }
  else { cf.style.display = "none"; }

  const extraHead = (currentView === "equipments" || currentView === "contracts")
    ? '<th width="1%">Docs</th>' : '';
  const thead = '<thead><tr>'+cols.map(c=>`<th>${c}</th>`).join('')+ extraHead +'<th width="1%"></th></tr></thead>';

  const tbodyHtml = '<tbody>'+ (rows||[]).map(r=>{
    const id = r.id ?? r.pma_no ?? r.task_id ?? r.user_id ?? '';
    const tds = cols.map(c=>`<td>${fmt(r[c])}</td>`).join('');
    const docsBtn =
      currentView==="equipments"
        ? `<button class="btn neutral sm" data-docs="${id}">Docs</button>`
      : currentView==="contracts"
        ? `<button class="btn neutral sm" data-cdocs="${id}">Docs</button>`
      : '';
    const docsTd = (currentView==="equipments" || currentView==="contracts") ? `<td>${docsBtn}</td>` : '';
    return `<tr data-id="${id}">
      ${tds}
      ${docsTd}
      <td class="actions">
        <div class="lr">
          <button class="btn secondary sm" data-edit="${id}">Edit</button>
          <button class="btn danger sm" data-del="${id}">Del</button>
        </div>
      </td>
    </tr>`;
  }).join('') +'</tbody>';

  $("#viewHost").innerHTML = `<table>${thead}${tbodyHtml}</table>`;
  $("#viewHost").querySelectorAll('[data-edit]').forEach(b=> b.addEventListener('click', ()=> openForm(currentView, b.dataset.edit)) );
  $("#viewHost").querySelectorAll('[data-del]').forEach(b=> b.addEventListener('click', ()=> removeRow(currentView, b.dataset.del)) );

  // Docs buttons
  $("#viewHost").querySelectorAll('[data-docs]').forEach(b=> b.addEventListener('click', ()=>{
    const id=b.dataset.docs;
    const row = (store.equipments||[]).find(x => String(x.id)===String(id));
    showEquipmentDocsDialog(id, row?.pma_no ?? null);
  }));
  $("#viewHost").querySelectorAll('[data-cdocs]').forEach(b=> b.addEventListener('click', ()=>{
    const id=b.dataset.cdocs;
    const row = (store.contracts||[]).find(x => String(x.id)===String(id));
    showContractDocsDialog(id, row?.pma_no ?? null, row?.building_name ?? null);
  }));

  // Row-click detail dialogs
  const tbodyEl = $("#viewHost table tbody");
  if (!tbodyEl) return;

  if (currentView === "equipments") {
    tbodyEl.addEventListener("click", (e) => {
      if (e.target.closest("button")) return;
      const tr = e.target.closest("tr[data-id]");
      if (!tr) return;
      const id = tr.dataset.id;
      if (id) showEquipmentDetails(id);
    });
  }
  if (currentView === "contracts") {
    tbodyEl.addEventListener("click", (e) => {
      if (e.target.closest("button")) return;
      const tr = e.target.closest("tr[data-id]");
      if (!tr) return;
      const id = tr.dataset.id;
      if (id) showContractDetails(id);
    });
  }
}

/* ===================== DATE & NUMBER SANITIZERS ===================== */
function parseAnyDate(val) {
  if (!val) return null;
  if (val instanceof Date) return isNaN(val) ? null : val;
  if (typeof val === "number") {
    const d = new Date(val);
    return isNaN(d) ? null : d;
  }
  const s = String(val).trim();
  if (!s) return null;

  const native = new Date(s);
  if (!isNaN(native)) return native;

  const m1 = s.match(/^(\d{1,2})-([A-Za-z]{3})-(\d{2,4})$/);
  if (m1) {
    const day = parseInt(m1[1], 10);
    const mon = m1[2].toLowerCase();
    let year = parseInt(m1[3], 10);
    const months = { jan:0,feb:1,mar:2,apr:3,may:4,jun:5,jul:6,aug:7,sep:8,oct:9,nov:10,dec:11 };
    const mm = months[mon];
    if (mm != null) {
      if (year < 100) year = year < 50 ? 2000 + year : 1900 + year;
      const d = new Date(Date.UTC(year, mm, day));
      return isNaN(d) ? null : d;
    }
  }
  const m2 = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
  if (m2) {
    const day = parseInt(m2[1], 10);
    const mm  = parseInt(m2[2], 10) - 1;
    let year  = parseInt(m2[3], 10);
    if (year < 100) year = year < 50 ? 2000 + year : 1900 + year;
    const d = new Date(Date.UTC(year, mm, day));
    return isNaN(d) ? null : d;
  }
  return null;
}
function isoDateOrNull(v){
  const d = parseAnyDate(v);
  return d ? d.toISOString().slice(0,10) : null;
}
const DATE_FIELDS = {
  contracts: ['pma_expiry','cf_validate','takeover_date','contract_start','contract_end','agreement_validity'],
  tasks:     ['due_date','checked_in_at','checked_out_at'],
  inspections:['scheduled_at','started_at','completed_at','pma_expiry','next_due'],
  equipments:['pma_expiry','contract_expiry'],
  sites:     [], hr:[], tools_mgmt:['calibration_due'], sub_contractors:[], support:['opened_at']
};
const NUMBER_FIELDS = {
  equipments: ['capacity_kg','capacity_persons','capacity_persons_per_hour','rise_m','stepwidth_mm','inclination','stops_openings']
};
function sanitizePayloadForTable(table, obj){
  const dates = new Set(DATE_FIELDS[table] || []);
  const nums  = new Set((NUMBER_FIELDS[table] || []).map(String));
  const out   = {};
  for (const [k,raw] of Object.entries(obj)){
    let v = typeof raw === 'string' ? raw.trim() : raw;
    if (v === '' || v === undefined) { out[k] = null; continue; }
    if (dates.has(k))     { out[k] = isoDateOrNull(v); continue; }
    if (nums.has(k))      { const n = Number(v); out[k] = Number.isFinite(n) ? n : null; continue; }
    out[k] = v;
  }
  return out;
}
function tableForView(view){
  if (['services','callbacks','repairs'].includes(view)) return 'tasks';
  if (['inspection_cf','inspection_14th'].includes(view)) return 'inspections';
  return view;
}

/* ===================== FORMS / CRUD ===================== */
function fieldsFor(view){
  if (["inspection_cf","inspection_14th"].includes(view)) return SCHEMAS.inspection;
  if (["services","callbacks","repairs"].includes(view))   return SCHEMAS.task;
  return SCHEMAS[view] || [];
}
function fieldHTML(f, val=""){
  const id="f_"+f.key;
  if(f.type==="textarea") return `<div style="grid-column:1/-1"><label for="${id}">${f.label}</label><textarea id="${id}">${fmt(val)}</textarea></div>`;
  return `<div><label for="${id}">${f.label}${f.required?' *':''}</label><input id="${id}" value="${fmt(val)}"/></div>`;
}
function collectFrom(dlg, view){
  const out = {};
  for (const f of fieldsFor(view)) {
    const el = byId(dlg, 'f_' + f.key);
    let v = (el?.value ?? "").trim();
    if (f.required && !v) { el?.focus(); return null; }
    out[f.key] = v === "" ? null : v;
  }
  return out;
}

function openForm(view, id){
  const isTaskPage       = ["services","callbacks","repairs"].includes(view);
  const isInspectionPage = ["inspection_cf","inspection_14th"].includes(view);

  const source =
    view==="contracts"   ? store.contracts   :
    isTaskPage           ? store.tasks       :
    isInspectionPage     ? store.inspections :
    view==="attendance"  ? store.attendance  :
    view==="checkins"    ? store.checkins    :
    view==="reports"     ? store.reports     :
    view==="sites"       ? store.sites       :
    view==="equipments"  ? store.equipments  : [];

  const row = (id? source.find(r=> String(r.id ?? r.pma_no ?? r.task_id ?? r.user_id)===String(id)) : null) || {};
  const docsSection =
    (id && (view==="equipments" || view==="contracts"))
      ? `<div style="grid-column:1/-1;display:flex;gap:8px;align-items:center;margin-top:6px">
           <input id="docFiles" type="file" multiple style="display:none" />
           <button class="btn neutral sm" id="chooseDocs" type="button">Add docs</button>
           <span class="muted" id="docHint">Upload will attach to this ${view.slice(0,-1)}.</span>
         </div>`
      : "";

  const dlg = document.createElement("dialog");
  dlg.innerHTML = `<form method="dialog">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0">${id?'Edit':'Add'} ${view.replace(/_/g,' ')}</h3>
      <button class="btn secondary" value="close" type="submit">‚úï</button>
    </header>
    <div class="grid" style="display:grid;grid-template-columns:repeat(2,minmax(160px,1fr));gap:12px">
      ${fieldsFor(view).map(f=> fieldHTML(f, row[f.key]) ).join('')}
      ${docsSection}
    </div>
    <div style="display:flex;justify-content:space-between;gap:8px;margin-top:14px">
      <div>${ id ? `<button class="btn danger" id="delBtn" type="button">Delete</button>` : '' }</div>
      <div>
        <button class="btn secondary" value="close" type="submit">Cancel</button>
        <button class="btn" id="saveBtn" type="button">${id?'Save':'Create'}</button>
      </div>
    </div>
  </form>`;
  document.body.appendChild(dlg); dlg.showModal();
  dlg.addEventListener("close", ()=> dlg.remove());

  $("#saveBtn", dlg)?.addEventListener("click", async ()=>{
    try{
      const payload = collectFrom(dlg, view);
      if(!payload) return;
      if(id) await updateRow(view, id, payload);
      else   await addRow(view, payload);
      await syncAll(); dlg.close();
      toast(id ? "Saved." : "Created.");
    }catch(err){ console.error(err); toast(`Error: ${err.message||err}`); }
  });

  $("#delBtn", dlg)?.addEventListener("click", async ()=>{
    if(confirm("Delete this record?")){
      try{ await removeRow(view, id); await syncAll(); dlg.close(); }
      catch(err){ toast(`Error: ${err.message||err}`); }
    }
  });

  // Docs upload
  if (id && (view==="equipments" || view==="contracts")) {
    $("#chooseDocs", dlg)?.addEventListener("click", ()=> $("#docFiles", dlg).click());
    $("#docFiles", dlg)?.addEventListener("change", async (e)=>{
      const files = Array.from(e.target.files || []);
      if(!files.length) return;
      try {
        if (view==="equipments") {
          await uploadDocsForEquipment(id, row?.pma_no ?? null, files);
        } else {
          await uploadDocsForContract(id, row?.pma_no ?? null, row?.building_name ?? null, files);
        }
        toast(`Uploaded ${files.length} file(s).`);
      } catch (err) {
        toast(`Upload failed: ${err.message||err}`);
      }
      e.target.value="";
    });
  }
}

function idFilter(id){ return `?id=eq.${encodeURIComponent(String(id))}`; }

async function addRow(view, payload){
  if (view === 'inspection_cf')  payload.subtype = 'cf_renewal';
  if (view === 'inspection_14th')payload.subtype = 'schedule_14th';
  if (['services','callbacks','repairs'].includes(view)){
    payload.type = view === 'services' ? 'service' : view === 'callbacks' ? 'callback' : 'repair';
  }
  const table   = tableForView(view);
  const clean   = sanitizePayloadForTable(table, payload);
  await restInsert(table, clean);
}
async function updateRow(view, id, patch){
  const table = tableForView(view);
  const qs    = idFilter(id);
  const clean = sanitizePayloadForTable(table, patch);
  await restUpdate(table, qs, clean);
}
async function removeRow(view, id){
  const qs = idFilter(id);
  if (["inspection_cf","inspection_14th"].includes(view)) {
    await restDelete("inspections", qs);
  } else if (["services","callbacks","repairs"].includes(view)) {
    await restDelete("tasks", qs);
  } else {
    await restDelete(view, qs);
  }
}

/* ===================== CSV IMPORT/EXPORT ===================== */
function parseCSV(text){
  const out=[]; let row=[], field='', i=0, q=false;
  while(i<=text.length){
    const c = text[i] ?? '\n';
    if(q){
      if(c === '"'){ if(text[i+1] === '"'){ field+='"'; i++; } else q=false; }
      else field+=c;
    }else{
      if(c === '"') q=true;
      else if(c === ','){ row.push(field); field=''; }
      else if(c === '\r'){ /* ignore */ }
      else if(c === '\n'){ row.push(field); out.push(row); row=[]; field=''; }
      else field+=c;
    }
    i++;
  }
  while(out.length && out[out.length-1].length===1 && out[out.length-1][0]==='') out.pop();
  return out;
}
function viewToTable(view){
  if (["services","callbacks","repairs"].includes(view)) return "tasks";
  if (["inspection_cf","inspection_14th"].includes(view)) return "inspections";
  return view;
}
function normalizeKey(s){ return String(s||'').trim().toLowerCase().replace(/[\s\-\/]+/g,'_'); }
function allowedKeysFor(view){ return new Set((fieldsFor(view)||[]).map(f=>f.key).concat(["id"])); }
function rowsToPayloads(view, header, rows){
  const allowed = allowedKeysFor(view);
  const keys = header.map(normalizeKey);
  const out=[];
  for(const r of rows){
    const o={};
    for(let i=0;i<keys.length;i++){
      const k=keys[i]; if(!k || !allowed.has(k)) continue;
      const v=r[i] ?? '';
      o[k]= v===''?null:v;
    }
    if(Object.keys(o).length) out.push(o);
  }
  return out;
}
async function importCsvForCurrentView(file){
  const table = viewToTable(currentView);
  const text = await file.text();
  const rows = parseCSV(text);
  if(!rows.length){ toast("CSV: no rows"); return; }
  const header = rows[0];
  const payloadsRaw = rowsToPayloads(currentView, header, rows.slice(1));
  const payloads    = payloadsRaw.map(p => sanitizePayloadForTable(table, p));
  if(!payloads.length){ toast("CSV: no valid data columns"); return; }

  const hasId = header.map(normalizeKey).includes('id');
  const onConflict = hasId ? "?on_conflict=id" : "";
  const prefer = hasId ? "return=representation,resolution=merge-duplicates" : "return=representation";

  const CHUNK=500; let done=0;
  for(let i=0;i<payloads.length;i+=CHUNK){
    const batch=payloads.slice(i,i+CHUNK);
    await restFetch(`/${table}${onConflict}`, { method:'POST', body:batch, prefer });
    done+=batch.length;
  }
  toast(`Imported ${done} row(s) into ${table}${hasId?' (upsert)':''}.`);
  await syncAll();
}
$("#importCsv").addEventListener("click", ()=>{ if(!UNLOCKED){ toast("Unlock first"); return; } $("#csvFile").value=""; $("#csvFile").click(); });
$("#csvFile").addEventListener("change",(e)=>{ const f=e.target.files?.[0]; if(f) importCsvForCurrentView(f).catch(err=>toast("Import failed: "+err.message)); });

$("#exportCsv").addEventListener("click", ()=>{
  if(!UNLOCKED){ toast("Unlock first"); return; }
  const table = $("#viewHost table"); if(!table){ toast("Nothing to export"); return; }
  const header = Array.from(table.querySelectorAll("thead th")).slice(0,-1).map(th=>th.textContent).join(",");
  const rows = Array.from(table.querySelectorAll("tbody tr")).map(tr =>
    Array.from(tr.querySelectorAll("td")).slice(0,-1).map(td=> `"${(td.textContent||'').replace(/"/g,'""')}"`).join(",")
  );
  const csv = [header, ...rows].join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob); a.download = `${currentView}.csv`; a.click(); URL.revokeObjectURL(a.href);
});

/* ===================== REALTIME (live updates) ===================== */
const RT_TABLES = [
  "contracts","equipments","tasks","inspections","sites",
  "reports","attendance","checkins","hr","tools_mgmt","sub_contractors","support",
  // docs tables for live refresh if others are open
  "equipment_docs","contract_docs"
];
function primaryKeyFor(table, row) {
  if (row?.id != null) return String(row.id);
  if (table === "equipments")  return String(row?.id ?? row?.pma_no ?? "");
  if (table === "contracts")   return String(row?.id ?? row?.pma_no ?? "");
  if (table === "reports")     return String(row?.id ?? row?.task_id ?? "");
  if (table === "attendance")  return String(row?.id ?? row?.user_id ?? "");
  return String(row?.id ?? row?.pma_no ?? row?.task_id ?? row?.user_id ?? "");
}
function applyChangeToStore(table, eventType, newRow, oldRow) {
  const key = table;
  if (!(key in store)) return; // ignore docs tables for main store
  const arr = store[key] || (store[key] = []);
  const newK = newRow ? primaryKeyFor(table, newRow) : "";
  const oldK = oldRow ? primaryKeyFor(table, oldRow) : newK;
  const idx  = arr.findIndex(r => primaryKeyFor(table, r) === oldK);

  if (eventType === "INSERT") {
    if (idx === -1) arr.unshift(newRow); else arr[idx] = newRow;
  } else if (eventType === "UPDATE") {
    if (idx !== -1) arr[idx] = {...arr[idx], ...newRow};
    else arr.unshift(newRow);
  } else if (eventType === "DELETE") {
    if (idx !== -1) arr.splice(idx, 1);
  }
}
const rerender = (() => { let t; return () => { clearTimeout(t); t=setTimeout(render, 80); }; })();
async function resyncTable(table) {
  try { store[table] = (await restSelectAll(table)) || []; rerender(); }
  catch (e) { console.warn("resync fail", table, e); }
}
function wireRealtime() {
  const ch = supa.channel("portal-realtime");
  RT_TABLES.forEach(table => {
    ch.on("postgres_changes", { event: "*", schema: "public", table }, (payload) => {
      const { eventType, new: n, old: o } = payload;
      applyChangeToStore(table, eventType, n, o);
      rerender();
    });
  });
  ch.subscribe((status) => {
    if (status === "SUBSCRIBED")       console.log("[Realtime] live");
    else if (status === "CHANNEL_ERROR") console.warn("[Realtime] error");
    else if (status === "CLOSED")        console.warn("[Realtime] closed");
  });
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") {
      const t = viewToTable(currentView);
      if (t) resyncTable(t);
    }
  });
}

/* ===================== DETAILS DIALOGS ===================== */
const EQUIPMENT_DETAIL_FIELDS = [
  "type","pma_no","name","location","brand","model_name",
  "capacity_kg","capacity_persons","capacity_persons_per_hour",
  "speed_m/m","rise_m","stops_openings","stepwidth_mm","inclination",
  "machine_type","motor_data","controller","software_version","operation",
  "roping","rope_diameter","rope_construction",
  "pma_status","pma_expiry","contract_status","contract_expiry","created_at","updated_at"
];
const CONTRACT_DETAIL_FIELDS = [
  "id","building_name","brand","equipment_type","number_lift","factory_code","location_state",
  "pma_no","pma_expiry","cf_validate","rates_per_month","contract_type",
  "takeover_date","contract_start","contract_end","agreement_validity","service",
  "contract_status","remark","created_at","updated_at"
];
function formatDateSafe(val) {
  const d = parseAnyDate(val);
  return d ? d.toISOString().slice(0, 10) : String(val ?? "");
}
function daysLeftSafe(val) {
  const d = parseAnyDate(val);
  if (!d) return null;
  const today = new Date();
  const D = Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate());
  const T = Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate());
  return Math.round((D - T) / 86400000);
}
function kvGrid(obj, keys) {
  const dateKeys = new Set(["pma_expiry","cf_validate","takeover_date","contract_start","contract_end","agreement_validity","created_at","updated_at"]);
  const badgeKeys = new Set(["pma_expiry","contract_end"]);
  return `
    <div style="display:grid;grid-template-columns: 220px 1fr; gap:10px;">
      ${keys.map(k => {
        let rawVal = obj?.[k];
        let val = dateKeys.has(k) ? formatDateSafe(rawVal) : fmt(rawVal);
        let badge = "";
        if (badgeKeys.has(k)) {
          const dLeft = daysLeftSafe(rawVal);
          if (typeof dLeft === "number") {
            const color = dLeft < 0 ? "var(--danger)" : (dLeft <= 30 ? "rgb(234,179,8)" : "var(--ok)");
            const text  = dLeft < 0 ? `${Math.abs(dLeft)} day(s) overdue`
                        : dLeft === 0 ? "expires today"
                        : `${dLeft} day(s) left`;
            badge = `<span style="margin-left:8px;padding:2px 8px;border-radius:999px;border:1px solid ${color};color:${color};font-size:12px">${text}</span>`;
          }
        }
        return `
          <div class="muted" style="word-break:break-word">${k}</div>
          <div style="word-break:break-word">${val}${badge}</div>
        `;
      }).join("")}
    </div>
  `;
}
function miniTable(headers, rows) {
  if (!rows?.length) return `<div class="muted">No records.</div>`;
  return `
    <div style="overflow:auto;border:1px solid rgba(255,255,255,.06);border-radius:10px">
      <table style="width:100%;border-collapse:collapse">
        <thead><tr>${headers.map(h=>`<th style="padding:8px 10px;font-size:12px;color:var(--fg2);border-bottom:1px solid rgba(255,255,255,.06)">${h}</th>`).join("")}</tr></thead>
        <tbody>
          ${rows.map(r=>`<tr>${headers.map(h=>`<td style="padding:8px 10px;border-bottom:1px solid rgba(255,255,255,.06)">${fmt(r[h])}</td>`).join("")}</tr>`).join("")}
        </tbody>
      </table>
    </div>
  `;
}
async function showEquipmentDetails(equipId){
  const dlg = document.createElement("dialog");
  dlg.className = "details";
  dlg.innerHTML = `
    <form method="dialog">
      <header>
        <h3>Equipment details</h3>
        <button class="btn secondary" value="close" type="submit">Close</button>
      </header>
      <div class="pad" id="equipBody"><div class="muted">Loading‚Ä¶</div></div>
    </form>`;
  document.body.appendChild(dlg); dlg.showModal();
  dlg.addEventListener("close", ()=> dlg.remove());

  try {
    const [eq] = await restSelectAll("equipments", `?id=eq.${encodeURIComponent(equipId)}`);
    if (!eq) { $("#equipBody", dlg).innerHTML = `<div class="muted">Equipment not found.</div>`; return; }
    const pma = eq.pma_no ?? eq.pma ?? null;

    const tasks   = pma ? await restSelectAll("tasks",   `?equipment_pma=eq.${encodeURIComponent(pma)}`) : [];
    const reports = pma ? await restSelectAll("reports", `?equipment_pma=eq.${encodeURIComponent(pma)}`) : [];

    const taskHeaders    = [ "title","type","status","priority","assigned_to","due_date","updated_at","created_at","completed_at"];
    const reportHeaders  = [ "title","remark","created_at","check_in_at","check_out_at"];

    $("#equipBody", dlg).innerHTML = `
      <section style="margin-bottom:16px">
        <h4 style="margin:0 0 10px">Overview</h4>
        ${kvGrid(eq, EQUIPMENT_DETAIL_FIELDS)}
      </section>
      <section style="margin-bottom:16px">
        <h4 style="margin:0 0 10px">Recent Tasks (equipment_pma = ${fmt(pma)})</h4>
        ${miniTable(taskHeaders, tasks)}
      </section>
      <section>
        <h4 style="margin:0 0 10px">Recent Reports (equipment_pma = ${fmt(pma)})</h4>
        ${miniTable(reportHeaders, reports)}
      </section>
    `;
  } catch (err) {
    $("#equipBody", dlg).innerHTML = `<div class="muted">Error: ${fmt(err.message)}</div>`;
  }
}
async function showContractDetails(contractId){
  const dlg = document.createElement("dialog");
  dlg.className = "details";
  dlg.innerHTML = `
    <form method="dialog">
      <header>
        <h3>Contract details</h3>
        <button class="btn secondary" value="close" type="submit">Close</button>
      </header>
      <div class="pad" id="contractBody"><div class="muted">Loading‚Ä¶</div></div>
    </form>`;
  document.body.appendChild(dlg); dlg.showModal();
  dlg.addEventListener("close", ()=> dlg.remove());

  try {
    const [c] = await restSelectAll("contracts", `?id=eq.${encodeURIComponent(contractId)}`);
    if (!c) { $("#contractBody", dlg).innerHTML = `<div class="muted">Contract not found.</div>`; return; }

    const pma = c.pma_no ?? null;
    const equipment = pma ? (await restSelectAll("equipments", `?pma_no=eq.${encodeURIComponent(pma)}`))[0] : null;
    const tasks = pma ? await restSelectAll("tasks", `?equipment_pma=eq.${encodeURIComponent(pma)}&order=created_at.desc`) : [];

    const taskHeaders = ["title","type","status","priority","assigned_to","due_date","updated_at"];
    const equipHeaders = ["type","name","brand","model_name","location","pma_status","pma_expiry","contract_status","contract_expiry"];

    $("#contractBody", dlg).innerHTML = `
      <section style="margin-bottom:16px">
        <h4 style="margin:0 0 10px">Overview</h4>
        ${kvGrid(c, CONTRACT_DETAIL_FIELDS)}
      </section>

      <section style="margin-bottom:16px">
        <h4 style="margin:0 0 10px">Linked Equipment ${pma ? `(PMA = ${fmt(pma)})` : ""}</h4>
        ${equipment ? miniTable(equipHeaders, [equipment]) : `<div class="muted">No equipment linked.</div>`}
      </section>

      <section>
        <h4 style="margin:0 0 10px">Recent Tasks ${pma ? `(equipment_pma = ${fmt(pma)})` : ""}</h4>
        ${miniTable(taskHeaders, tasks)}
      </section>
    `;
  } catch (err) {
    $("#contractBody", dlg).innerHTML = `<div class="muted">Error: ${fmt(err.message)}</div>`;
  }
}

/* ===================== STORAGE UTILS & DOCS (Equipments + Contracts) ===================== */
async function signedUrl(path){
  const { data, error } = await supa.storage.from(DOCS_BUCKET).createSignedUrl(path, 60*10);
  if (error) throw new Error(error.message);
  return data.signedUrl;
}

/* ===== Equipment Docs ===== */
function equipmentDocPath(equipmentId, file){
  const ts = Date.now();
  const rnd = (crypto?.randomUUID?.() || Math.random().toString(36).slice(2));
  const safeName = file.name.replace(/[^\w.\- ]+/g,'_');
  return `equipments/${encodeURIComponent(String(equipmentId))}/${ts}_${rnd}_${safeName}`;
}
async function uploadDocsForEquipment(equipmentId, pmaNo, files, extras={}){
  if(!files?.length) return [];
  const bucket = supa.storage.from(DOCS_BUCKET);
  const rows = [];
  for (const file of files){
    const path = equipmentDocPath(equipmentId, file);
    const { error } = await bucket.upload(path, file, { upsert:true, contentType:file.type || undefined });
    if (error) throw new Error(error.message);
    rows.push({
      equipment_id: equipmentId,
      pma_no: pmaNo ?? null,
      file_name: file.name,
      file_path: path,
      content_type: file.type || null,
      file_size: file.size ?? null,
      category: extras.category ?? null,
      note: extras.note ?? null,
      uploaded_by: extras.uploadedBy ?? null
    });
  }
  if(rows.length) await restInsert('equipment_docs', rows);
  return rows;
}
async function listDocsForEquipment(equipmentId){
  return await restSelectAll('equipment_docs', `?equipment_id=eq.${encodeURIComponent(equipmentId)}&order=uploaded_at.desc`);
}
async function deleteEquipmentDocById(docId){
  const [doc] = await restSelectAll('equipment_docs', `?id=eq.${encodeURIComponent(docId)}`);
  if (!doc) return;
  const bucket = supa.storage.from(DOCS_BUCKET);
  await bucket.remove([doc.file_path]);
  await restDelete('equipment_docs', `?id=eq.${encodeURIComponent(docId)}`);
}
async function showEquipmentDocsDialog(equipmentId, pmaNo){
  const dlg = document.createElement("dialog");
  dlg.className = "details";
  dlg.innerHTML = `
    <form method="dialog">
      <header>
        <h3>Equipment Documents</h3>
        <div>
          <input id="eDocAddFiles" type="file" multiple style="display:none" />
          <button class="btn neutral sm" id="eDocAddBtn" type="button">Upload more</button>
          <button class="btn secondary sm" value="close" type="submit">Close</button>
        </div>
      </header>
      <div class="pad">
        <div class="muted" style="margin:-2px 0 10px 0">
          ${pmaNo ? `PMA: <b>${pmaNo}</b>` : ''}
        </div>
        <div id="eDocsBody"><div class="muted">Loading‚Ä¶</div></div>
      </div>
    </form>`;
  document.body.appendChild(dlg); dlg.showModal();
  dlg.addEventListener("close", ()=> dlg.remove());

  async function refresh(){
    const rows = await listDocsForEquipment(equipmentId);
    const html = `
      <div style="overflow:auto;border:1px solid rgba(255,255,255,.10);border-radius:10px">
        <table>
          <thead>
            <tr>
              <th>File name</th><th>Category</th><th>Size</th><th>Type</th>
              <th>Uploaded by</th><th>Uploaded at</th><th width="1%"></th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r=>`
              <tr data-doc="${r.id}">
                <td>${fmt(r.file_name)}</td>
                <td>${fmt(r.category)}</td>
                <td>${r.file_size!=null ? (Math.round(r.file_size/1024))+' KB' : ''}</td>
                <td>${fmt(r.content_type)}</td>
                <td>${fmt(r.uploaded_by)}</td>
                <td>${fmt(r.uploaded_at)}</td>
                <td style="white-space:nowrap">
                  <button class="btn secondary sm" data-open="${r.id}">Open</button>
                  <button class="btn danger sm" data-rm="${r.id}">Del</button>
                </td>
              </tr>`).join("")}
          </tbody>
        </table>
      </div>`;
    $("#eDocsBody", dlg).innerHTML = html;

    $("#eDocsBody", dlg).querySelectorAll('[data-open]').forEach(b=> b.addEventListener('click', async ()=>{
      const id=b.dataset.open;
      const row = rows.find(x=>x.id===id); if(!row) return;
      try{ const url = await signedUrl(row.file_path); window.open(url, "_blank"); }
      catch(err){ toast('Open failed: '+(err.message||err)); }
    }));
    $("#eDocsBody", dlg).querySelectorAll('[data-rm]').forEach(b=> b.addEventListener('click', async ()=>{
      const id=b.dataset.rm;
      if(!confirm('Delete this file?')) return;
      try{ await deleteEquipmentDocById(id); await refresh(); toast('Deleted.'); }
      catch(err){ toast('Delete failed: '+(err.message||err)); }
    }));
  }
  await refresh();

  $("#eDocAddBtn", dlg).addEventListener("click", ()=> $("#eDocAddFiles", dlg).click());
  $("#eDocAddFiles", dlg).addEventListener("change", async (e)=>{
    const files = Array.from(e.target.files||[]);
    if(!files.length) return;
    try{
      await uploadDocsForEquipment(equipmentId, pmaNo ?? null, files);
      await refresh();
      toast(`Uploaded ${files.length} file(s).`);
    } catch(err){ toast('Upload failed: '+(err.message||err)); }
    e.target.value="";
  });
}

/* ===== Contract Docs ===== */
function contractDocPath(contractId, file){
  const ts = Date.now();
  const rnd = (crypto?.randomUUID?.() || Math.random().toString(36).slice(2));
  const safeName = file.name.replace(/[^\w.\- ]+/g,'_');
  return `contracts/${encodeURIComponent(String(contractId))}/${ts}_${rnd}_${safeName}`;
}
async function uploadDocsForContract(contractId, pmaNo, buildingName, files, extras={}){
  if(!files?.length) return [];
  const bucket = supa.storage.from(DOCS_BUCKET);
  const rows = [];
  for (const file of files){
    const path = contractDocPath(contractId, file);
    const { error } = await bucket.upload(path, file, { upsert:true, contentType:file.type || undefined });
    if (error) throw new Error(error.message);
    rows.push({
      contract_id: contractId,
      pma_no: pmaNo ?? null,
      building_name: buildingName ?? null,
      file_name: file.name,
      file_path: path,
      content_type: file.type || null,
      file_size: file.size ?? null,
      category: extras.category ?? null,
      note: extras.note ?? null,
      uploaded_by: extras.uploadedBy ?? null
    });
  }
  if(rows.length) await restInsert('contract_docs', rows);
  return rows;
}
async function listDocsForContract(contractId){
  return await restSelectAll('contract_docs', `?contract_id=eq.${encodeURIComponent(contractId)}&order=uploaded_at.desc`);
}
async function deleteContractDocById(docId){
  const [doc] = await restSelectAll('contract_docs', `?id=eq.${encodeURIComponent(docId)}`);
  if (!doc) return;
  const bucket = supa.storage.from(DOCS_BUCKET);
  await bucket.remove([doc.file_path]);
  await restDelete('contract_docs', `?id=eq.${encodeURIComponent(docId)}`);
}
async function showContractDocsDialog(contractId, pmaNo, buildingName){
  const dlg = document.createElement("dialog");
  dlg.className = "details";
  dlg.innerHTML = `
    <form method="dialog">
      <header>
        <h3>Contract Documents</h3>
        <div>
          <input id="cDocAddFiles" type="file" multiple style="display:none" />
          <button class="btn neutral sm" id="cDocAddBtn" type="button">Upload more</button>
          <button class="btn secondary sm" value="close" type="submit">Close</button>
        </div>
      </header>
      <div class="pad">
        <div class="muted" style="margin:-2px 0 10px 0">
          ${buildingName ? `Building: <b>${buildingName}</b> ‚Ä¢ ` : ''} ${pmaNo ? `PMA: <b>${pmaNo}</b>` : ''}
        </div>
        <div id="cDocsBody"><div class="muted">Loading‚Ä¶</div></div>
      </div>
    </form>`;
  document.body.appendChild(dlg); dlg.showModal();
  dlg.addEventListener("close", ()=> dlg.remove());

  async function refresh(){
    const rows = await listDocsForContract(contractId);
    const html = `
      <div style="overflow:auto;border:1px solid rgba(255,255,255,.10);border-radius:10px">
        <table>
          <thead>
            <tr>
              <th>File name</th><th>Category</th><th>Size</th><th>Type</th>
              <th>Uploaded by</th><th>Uploaded at</th><th width="1%"></th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r=>`
              <tr data-doc="${r.id}">
                <td>${fmt(r.file_name)}</td>
                <td>${fmt(r.category)}</td>
                <td>${r.file_size!=null ? (Math.round(r.file_size/1024))+' KB' : ''}</td>
                <td>${fmt(r.content_type)}</td>
                <td>${fmt(r.uploaded_by)}</td>
                <td>${fmt(r.uploaded_at)}</td>
                <td style="white-space:nowrap">
                  <button class="btn secondary sm" data-open="${r.id}">Open</button>
                  <button class="btn danger sm" data-rm="${r.id}">Del</button>
                </td>
              </tr>`).join("")}
          </tbody>
        </table>
      </div>`;
    $("#cDocsBody", dlg).innerHTML = html;

    $("#cDocsBody", dlg).querySelectorAll('[data-open]').forEach(b=> b.addEventListener('click', async ()=>{
      const id=b.dataset.open;
      const row = rows.find(x=>x.id===id); if(!row) return;
      try{ const url = await signedUrl(row.file_path); window.open(url, "_blank"); }
      catch(err){ toast('Open failed: '+(err.message||err)); }
    }));
    $("#cDocsBody", dlg).querySelectorAll('[data-rm]').forEach(b=> b.addEventListener('click', async ()=>{
      const id=b.dataset.rm;
      if(!confirm('Delete this file?')) return;
      try{ await deleteContractDocById(id); await refresh(); toast('Deleted.'); }
      catch(err){ toast('Delete failed: '+(err.message||err)); }
    }));
  }
  await refresh();

  $("#cDocAddBtn", dlg).addEventListener("click", ()=> $("#cDocAddFiles", dlg).click());
  $("#cDocAddFiles", dlg).addEventListener("change", async (e)=>{
    const files = Array.from(e.target.files||[]);
    if(!files.length) return;
    try{
      await uploadDocsForContract(contractId, pmaNo ?? null, buildingName ?? null, files);
      await refresh();
      toast(`Uploaded ${files.length} file(s).`);
    } catch(err){ toast('Upload failed: '+(err.message||err)); }
    e.target.value="";
  });
}

/* ===================== INIT ===================== */
renderSidebar();
wirePageSearch();
updateNewBtnLabel();
document.addEventListener("keydown", e=>{
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); $("#q").focus(); }
});
const qInput = $("#q");
qInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    e.preventDefault();
    const q = qInput.value.trim();
    if (q) globalSearch(q);
  } else if (e.key === "Escape") {
    e.preventDefault();
    qInput.value = "";
  }
});
$("#newBtn").addEventListener("click", ()=> openForm(currentView, null) );
</script>
</body>
</html>
