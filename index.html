<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TRIDENT Portal</title>
  <style>
    :root{
      --bg:#0b1220;--bg2:#0e1626;--panel:#0f172a;--muted:#8aa0b8;--ring:#60a5fa;
      --fg:#e2e8f0;--fg2:#cbd5e1;--brand:#2563eb;--ok:#16a34a;--danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg2));color:var(--fg);
         font:14px/1.45 system-ui,Segoe UI,Inter,Roboto,Helvetica,Arial,sans-serif}
    .app{display:flex;height:100%}
    .sidebar{width:260px;min-width:240px;background:rgba(16,24,40,.90);backdrop-filter: blur(8px);
             border-right:1px solid rgba(255,255,255,.06);display:flex;flex-direction:column}
    .sidebar header{padding:16px 14px;border-bottom:1px solid rgba(255,255,255,.06);font-weight:700}
    .nav{padding:8px 6px;overflow:auto}
    .group{margin:10px 0}
    .group .title{opacity:.7;text-transform:uppercase;font-size:11px;letter-spacing:.12em;margin:6px 10px}
    .item{display:flex;gap:10px;align-items:center;padding:9px 10px;margin:4px 6px;border-radius:10px;cursor:pointer}
    .item:hover{background:rgba(255,255,255,.06)}
    .item.active{background:rgba(37,99,235,.18);outline:1px solid rgba(37,99,235,.35)}
    .main{flex:1;display:flex;flex-direction:column;min-width:0}
    .toolbar{display:flex;justify-content:space-between;align-items:center;padding:14px;border-bottom:1px solid rgba(255,255,255,.06)}
    .search{display:flex;gap:8px;align-items:center;background:rgba(255,255,255,.06);padding:8px 12px;border-radius:10px;min-width:280px}
    .search input{all:unset;flex:1}
    .content{padding:16px;overflow:auto}
    .panel{background:var(--panel);border:1px solid #334155;border-radius:14px}
    .panel header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.06)}
    .panel .body{padding:12px 14px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:9px 12px;border:1px solid rgba(59,130,246,.55);border-radius:12px;background:linear-gradient(#2b65f6,#1d4ed8);color:#fff;font-weight:700}
    .btn.secondary{background:rgba(255,255,255,.06);border-color:#475569;color:#e5e7eb}
    .btn.danger{background:#b91c1c;border-color:#b91c1c}
    .btn.sm { padding:.38rem .6rem; border-radius:10px; font-weight:600; }
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid rgba(255,255,255,.06);padding:10px;text-align:left;vertical-align:top}
    th{font-size:12px;color:var(--fg2)}
    tr:hover td{background:rgba(255,255,255,.03)}
    td.actions { width:1%; min-width:170px; white-space:nowrap; }
    td.actions .lr {display:flex; justify-content:space-between; align-items:center; gap:.5rem; min-width:170px}
    .muted{color:var(--muted)}
    dialog{background:rgba(16,24,40,.98);border:1px solid rgba(255,255,255,.1);border-radius:16px}
    dialog form{padding:16px}
    label{display:block;margin-bottom:6px;font-size:12px;color:var(--fg2);font-weight:600}
    input,select,textarea{width:100%;background:#0b1220;border:1px solid #3a4a61;color:var(--fg);padding:8px;border-radius:10px}
    input:focus,select:focus,textarea:focus{outline:2px solid var(--ring);box-shadow:0 0 0 3px rgba(96,165,250,.25);border-color:#60a5fa}
    .toast{position:fixed;right:16px;bottom:14px;background:#0b1220;border:1px solid #475569;border-radius:12px;padding:10px 12px;box-shadow:0 10px 20px rgba(0,0,0,.35);z-index:60}
    #lock{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#0b1220;border:1px solid #475569;border-radius:16px;padding:18px;width:min(520px,92vw);z-index:50}
    #lock h3{margin:0 0 10px}
    #lock .row{display:flex;gap:8px}
    #error{display:none;background:rgba(239,68,68,.15);color:#fecaca;border:1px solid rgba(239,68,68,.35);padding:8px 10px;border-radius:10px;margin:8px 0}
    @media (max-width: 880px){ .sidebar{position:fixed;transform:translateX(-100%);z-index:70;transition:.25s} .sidebar.show{transform:translateX(0)} }
  </style>
</head>
<body>
<div class="app">
  <aside class="sidebar" id="sidebar"></aside>

  <main class="main">
    <div class="toolbar">
      <div class="search">
        <span class="muted">ðŸ”Ž</span>
        <input id="q" placeholder="Search records (âŒ˜/Ctrl + K)" />
      </div>
      <div class="actions">
        <button class="btn secondary" id="exportCsv">Export CSV</button>
        <button class="btn" id="newBtn">+ New</button>
      </div>
    </div>

    <div class="content">
      <div class="panel">
        <header>
          <div>
            <h3 id="title" style="margin:0">Services</h3>
            <div class="muted"><span id="count">0</span> row(s)</div>
          </div>
          <div class="muted" id="statusText"></div>
        </header>
        <div class="body" id="viewHost"></div>
      </div>
    </div>
  </main>
</div>

<div id="toast" class="toast" style="display:none"></div>

<div id="lock">
  <h3>Enter Passcode</h3>
  <div id="error">Incorrect passcode. Try again.</div>
  <div class="row">
    <input id="lockpw" type="password" placeholder="Passcode" autocomplete="off" required />
    <button class="btn" id="unlock">Unlock</button>
  </div>
</div>

<script>
/* =========================================================
   BASIC UTILS
========================================================= */
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
const fmt = v => v==null ? '' : String(v);
function toast(msg){ const t=$("#toast"); t.textContent=msg; t.style.display='block'; setTimeout(()=>{t.style.display='none';}, 2600); }
function parseTS(x){ try{ return x? new Date(x): null }catch{ return null } }
function minutesDiff(a,b){ if(!a||!b) return null; return Math.round((b-a)/60000) }

/* =========================================================
   SUPABASE REST CONFIG  (CHANGE THESE TWO)
========================================================= */
const SUPABASE_URL  = 'https://cxxcrtxwrhxymlybxljs.supabase.co';
const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN4eGNydHh3cmh4eW1seWJ4bGpzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE1NDU4NzgsImV4cCI6MjA3NzEyMTg3OH0.ehMiF9uPgpW_eST549RvvlK2KrpPm9NJ1qhtz3tErqc';

const REST = `${SUPABASE_URL}/rest/v1`;
async function restFetch(path, { method='GET', body, prefer } = {}) {
  const res = await fetch(`${REST}${path}`, {
    method,
    headers: {
      apikey: SUPABASE_ANON,
      Authorization: `Bearer ${SUPABASE_ANON}`,
      'Content-Type': 'application/json',
      ...(prefer ? { Prefer: prefer } : {})
    },
    body: body ? JSON.stringify(body) : undefined
  });
  if(!res.ok){
    const text = await res.text().catch(()=> '');
    throw new Error(`[${res.status}] ${text || res.statusText}`);
  }
  const ct = res.headers.get('content-type') || '';
  return ct.includes('application/json') ? res.json() : null;
}
const restSelect = (table, qs) => restFetch(`/${table}${qs?.startsWith('?')?qs:(qs?`?${qs}`:'')}`);
const restInsert = (table, rows) => restFetch(`/${table}`, { method:'POST', body: rows, prefer:'return=representation' });
const restUpdate = (table, filterQS, patch) => restFetch(`/${table}${filterQS}`, { method:'PATCH', body: patch, prefer:'return=representation' });
const restDelete = (table, filterQS) => restFetch(`/${table}${filterQS}`, { method:'DELETE' });

/* =========================================================
   PASSGATE (same as before)
========================================================= */
const PASS_PLAIN="TRIDENTHUB_portal", PASS_SALT="ideal-lab-trident-2025", PASS_ITER=150000;
const PASS_HASH="089d2a57b838e21e6d15e2047a8fa824d4a0132744ce7141db0aea3fd940218f";
let UNLOCKED=false;
async function hashPass(p,s=PASS_SALT,i=PASS_ITER){
  if(!crypto?.subtle) return null;
  const enc=new TextEncoder();
  const key=await crypto.subtle.importKey("raw",enc.encode(p),"PBKDF2",false,["deriveBits"]);
  const bits=await crypto.subtle.deriveBits({name:"PBKDF2",hash:"SHA-256",salt:enc.encode(s),iterations:i},key,256);
  return Array.from(new Uint8Array(bits)).map(b=>b.toString(16).padStart(2,'0')).join("");
}
$("#unlock").addEventListener("click", async ()=>{
  $("#error").style.display="none";
  const dig = await hashPass($("#lockpw").value || "");
  if( (dig && dig===PASS_HASH) || (!dig && $("#lockpw").value===PASS_PLAIN) ){
    UNLOCKED=true; $("#lock").hidden=true; renderSidebar(); await syncAll();
  } else { $("#error").style.display="block"; }
});

/* =========================================================
   DATA + NAV + COLUMNS PER TABLE
========================================================= */
let currentView = "services";

/** Weâ€™ll show a *sane subset* of columns so the table stays readable. */
const COLUMNS = {
  services:   ["id","title","status","priority","assigned_to","due_date","location","equipment_pma","checked_in_at","checked_out_at","updated_at"],
  callbacks:  ["id","title","status","priority","assigned_to","due_date","location","equipment_pma","checked_in_at","checked_out_at","updated_at"],
  repairs:    ["id","title","status","priority","assigned_to","due_date","location","equipment_pma","checked_in_at","checked_out_at","updated_at"],
  inspection_cf:   ["id","title","status","priority","assigned_to","due_date","location","equipment_pma","checked_in_at","checked_out_at","updated_at"],
  inspection_14th: ["id","title","status","priority","assigned_to","due_date","location","equipment_pma","checked_in_at","checked_out_at","updated_at"],

  attendance: ["id","user_id","user_name","check_in_at","check_out_at","location_name"],

  checkins:   ["id","user_id","latitude","longitude","photo_path","created_at"],

  reports:    ["id","task_id","title","description","location","equipment_pma","remark","check_in_at","check_out_at","completed_at","created_by_id","assigned_to_id"],

  equipments: ["id","type","pma_no","location","brand","model_name","pma_status","pma_expiry","contract_status","contract_expiry","updated_at"]
};

/** Forms: small set of editable fields (safe to post) */
const SCHEMAS = {
  task: [
    {key:'title',label:'Title',required:true},
    {key:'type',label:'Type (service/callback/repair/inspection)'},
    {key:'status',label:'Status (open/in_progress/closed)'},
    {key:'priority',label:'Priority (low/normal/high/urgent)'},
    {key:'assigned_to',label:'Assigned to'},
    {key:'location',label:'Location'},
    {key:'equipment_pma',label:'Equipment PMA'},
    {key:'due_date',label:'Due date (YYYY-MM-DD)'},
    {key:'checked_in_at',label:'Checked in at (ISO)'},
    {key:'checked_out_at',label:'Checked out at (ISO)'},
    {key:'remark',label:'Remark'},
    {key:'description',label:'Description',type:'textarea'}
  ],
  attendance: [
    {key:'user_id',label:'User id'},
    {key:'user_name',label:'User name'},
    {key:'check_in_at',label:'Check in at (ISO)'},
    {key:'check_out_at',label:'Check out at (ISO)'},
    {key:'location_name',label:'Location name'}
  ],
  reports: [
    {key:'task_id',label:'Task id'},
    {key:'title',label:'Title'},
    {key:'description',label:'Description',type:'textarea'},
    {key:'location',label:'Location'},
    {key:'equipment_pma',label:'Equipment PMA'},
    {key:'remark',label:'Remark'},
    {key:'check_in_at',label:'Check in at (ISO)'},
    {key:'check_out_at',label:'Check out at (ISO)'}
  ],
  equipments: [
    {key:'type',label:'Type'},
    {key:'pma_no',label:'PMA'},
    {key:'location',label:'Location'},
    {key:'brand',label:'Brand'},
    {key:'model_name',label:'Model name'},
    {key:'pma_status',label:'PMA status'},
    {key:'pma_expiry',label:'PMA expiry (date)'},
    {key:'contract_status',label:'Contract status'},
    {key:'contract_expiry',label:'Contract expiry (date)'}
  ]
};

const NAV = [
  { title:"Sales", items:[ {key:"new_contract", label:"New Contract"} ]},
  { title:"Project", items:[ {key:"new_project",  label:"New Installation"} ]},

  { title:"Service Ops", items:[
    {key:"services",   label:"Services"},
    {key:"callbacks",  label:"Call Back"},
    {key:"repairs",    label:"Repair"},
    {key:"clients",    label:"Clients"},
    {key:"sites",      label:"Sites"},
    {key:"equipments", label:"Equipments"}
  ]},

  { title:"Compliance", items:[
    {key:"inspection_cf",     label:"CF Renewal Inspection"},
    {key:"inspection_14th",   label:"14th Schedule Inspection"}
  ]}
];


/* Runtime store */
const store = {
  tasks: [],
  attendance: [],
  checkins: [],
  reports: [],
  equipments: []
};

/* =========================================================
   SIDEBAR + NAV
========================================================= */
function renderSidebar(){
  const sb = $("#sidebar");
  sb.innerHTML = `
    <header>TRIDENT HUB</header>
    <div class="nav">
      ${NAV.map(g => `
        <div class="group">
          <div class="title">${g.title}</div>
          ${g.items.map(it => `
            <div class="item ${currentView===it.key?'active':''}" data-view="${it.key}">${it.label}</div>
          `).join('')}
        </div>
      `).join('')}
    </div>
  `;
  $$(".item", sb).forEach(el=> el.addEventListener("click", ()=> setActive(el.dataset.view)) );
}
function setActive(v){ currentView=v; renderSidebar(); render(); }

/* =========================================================
   FETCH (reads only your real tables)
========================================================= */
async function syncAll(){
  const safe = p => p.then(x=>x||[]).catch(e=>{console.warn(e); return []});
  const [
    tasks, attendance, checkins, reports, equipments
  ] = await Promise.all([
    safe(restSelect("tasks", "select=*")),
    safe(restSelect("attendance", "select=*")),
    safe(restSelect("checkins", "select=*")),
    safe(restSelect("reports", "select=*")),
    safe(restSelect("equipments", "select=*"))
  ]);
  store.tasks = tasks;
  store.attendance = attendance;
  store.checkins = checkins;
  store.reports = reports;
  store.equipments = equipments;
  render();
}

/* =========================================================
   RENDER
========================================================= */
const normalize = s => (s||"").toLowerCase().replace(/[\s\-_]+/g,"");

function rowsFor(view){
  if(["services","callbacks","repairs","inspections"].includes(view)){
    const typ = view==="services"?"service":view==="callbacks"?"callback":view==="repairs"?"repair":"inspection";
    return (store.tasks||[]).filter(t => normalize(t.type)===typ);
  }
  if(view==="attendance"){
    return (store.attendance||[]).map(a=>{
      const ci=parseTS(a.check_in_at), co=parseTS(a.check_out_at);
      return {...a, duration_min: minutesDiff(ci,co) };
    });
  }
  if(view==="checkins") return store.checkins||[];
  if(view==="reports")  return store.reports||[];
  if(view==="equipments"){
    // Ensure an ID-like key for table row (prefer id, else pma)
    return (store.equipments||[]).map(e => ({ id: e.id ?? e.pma_no ?? e.type, ...e }));
  }
  return [];
}

function render(){
  if(!UNLOCKED){ $("#viewHost").innerHTML = '<div class="muted">Locked.</div>'; return; }
  const rows = rowsFor(currentView);
  const cols = COLUMNS[currentView] || [];
  const title = currentView.replace(/_/g,' ').replace(/^\w/,c=>c.toUpperCase());
  $("#title").textContent = title;
  $("#count").textContent = rows?.length || 0;

  const thead = '<thead><tr>'+cols.map(c=>`<th>${c}</th>`).join('')+'<th width="1%"></th></tr></thead>';
  const tbody = '<tbody>'+ (rows||[]).map(r=>{
    const id = r.id ?? r.pma_no ?? r.task_id ?? r.user_id ?? '';
    const tds = cols.map(c=>`<td>${fmt(r[c])}</td>`).join('');
    return `<tr data-id="${id}">
      ${tds}
      <td class="actions">
        <div class="lr">
          <button class="btn secondary sm" data-edit="${id}">Edit</button>
          <button class="btn danger sm" data-del="${id}">Del</button>
        </div>
      </td>
    </tr>`;
  }).join('') +'</tbody>';

  $("#viewHost").innerHTML = `<table>${thead}${tbody}</table>`;
  $("#viewHost").querySelectorAll('[data-edit]').forEach(b=> b.addEventListener('click', ()=> openForm(currentView, b.dataset.edit)) );
  $("#viewHost").querySelectorAll('[data-del]').forEach(b=> b.addEventListener('click', ()=> removeRow(currentView, b.dataset.del)) );
}

/* =========================================================
   FORMS / CRUD
========================================================= */
function fieldsFor(view){
  if(["services","callbacks","repairs","inspections"].includes(view)) return SCHEMAS.task;
  return SCHEMAS[view] || [];
}
function fieldHTML(f, val=""){
  const id="f_"+f.key;
  if(f.type==="textarea") return `<div style="grid-column:1/-1"><label for="${id}">${f.label}</label><textarea id="${id}">${fmt(val)}</textarea></div>`;
  return `<div><label for="${id}">${f.label}${f.required?' *':''}</label><input id="${id}" value="${fmt(val)}"/></div>`;
}
function collectFrom(dlg, view){
  const out={};
  for(const f of fieldsFor(view)){
    const el=dlg.querySelector("#f_"+f.key);
    let v=(el?.value ?? "").trim();
    if(f.required && !v){ el?.focus(); return null; }
    out[f.key]= v===""?null:v;
  }
  return out;
}

function openForm(view, id){
  const isTask = ["services","callbacks","repairs","inspections"].includes(view);
  const fixedType = isTask ? (view==="services"?"service":view==="callbacks"?"callback":view==="repairs"?"repair":view==="inspections"?"inspection":null) : null;

  const source =
    isTask ? store.tasks :
    view==="attendance" ? store.attendance :
    view==="checkins"   ? store.checkins   :
    view==="reports"    ? store.reports    :
    view==="equipments" ? store.equipments : [];

  const row = (id? source.find(r=> String(r.id ?? r.pma_no ?? r.task_id ?? r.user_id)===String(id)) : null) || {};
  const dlg = document.createElement("dialog");
  dlg.innerHTML = `<form method="dialog">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h3 style="margin:0">${id?'Edit':'Add'} ${view.replace(/_/g,' ')}</h3>
      <button class="btn secondary" value="close">âœ•</button>
    </header>
    <div class="grid" style="display:grid;grid-template-columns:repeat(2,minmax(160px,1fr));gap:12px">
      ${fieldsFor(view).map(f=> fieldHTML(f, row[f.key]) ).join('')}
    </div>
    <div style="display:flex;justify-content:space-between;gap:8px;margin-top:14px">
      <div>${ id ? `<button class="btn danger" id="delBtn">Delete</button>` : '' }</div>
      <div>
        <button class="btn secondary" value="close">Cancel</button>
        <button class="btn" id="saveBtn" value="default">${id?'Save':'Create'}</button>
      </div>
    </div>
  </form>`;
  document.body.appendChild(dlg); dlg.showModal();
  dlg.addEventListener("close", ()=> dlg.remove());

  $("#saveBtn", dlg)?.addEventListener("click", async (e)=>{
    e.preventDefault();
    const payload = collectFrom(dlg, view); if(!payload) return;
    try{
      if(isTask && fixedType) payload.type = fixedType;
      if(id) await updateRow(view, id, payload);
      else   await addRow(view, payload);
      await syncAll(); dlg.close();
    }catch(err){ toast(err.message); }
  });

  $("#delBtn", dlg)?.addEventListener("click", async (e)=>{
    e.preventDefault();
    if(confirm("Delete this record?")){ try{ await removeRow(view, id); await syncAll(); dlg.close(); }catch(err){ toast(err.message);} }
  });
}

function idFilter(id){ return `?id=eq.${encodeURIComponent(String(id))}`; }

async function addRow(view, payload){
  if(["services","callbacks","repairs","inspections"].includes(view)) await restInsert("tasks", payload);
  else await restInsert(view, payload); 
}
async function updateRow(view, id, patch){
  const qs = idFilter(id);
  if(["services","callbacks","repairs","inspections"].includes(view)) await restUpdate("tasks", qs, patch);
  else await restUpdate(view, qs, patch);
}
async function removeRow(view, id){
  const qs = idFilter(id);
  if(["services","callbacks","repairs","inspections"].includes(view)) await restDelete("tasks", qs);
  else await restDelete(view, qs);
}

/* =========================================================
   BUTTONS
========================================================= */
$("#newBtn").addEventListener("click", ()=> openForm(currentView, null) );
$("#exportCsv").addEventListener("click", ()=>{
  const table = $("#viewHost table"); if(!table){ toast("Nothing to export"); return; }
  const header = Array.from(table.querySelectorAll("thead th")).slice(0,-1).map(th=>th.textContent).join(",");
  const rows = Array.from(table.querySelectorAll("tbody tr")).map(tr =>
    Array.from(tr.querySelectorAll("td")).slice(0,-1).map(td=> `"${(td.textContent||'').replace(/"/g,'""')}"`).join(",")
  );
  const csv = [header, ...rows].join("\n");
  const blob = new Blob([csv], {type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob); a.download = `${currentView}.csv`; a.click(); URL.revokeObjectURL(a.href);
});

/* =========================================================
   INIT
========================================================= */
renderSidebar();
document.addEventListener("keydown", e=>{
  if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); $("#q").focus(); }
});
</script>
</body>
</html>
